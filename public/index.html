<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rivalytics - Dashboard</title>
    <link rel="icon" href="/favicon-v2.ico" />
    <meta name="theme-color" content="#0b0f1a" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root{
        --glass-bg: rgba(255,255,255,.16);
        --glass-stroke: rgba(255,255,255,.35);
        --glass-shadow: 0 10px 30px rgba(2, 8, 23, .20), inset 0 0 0 1px rgba(255,255,255,.12);
        --chip-stroke: rgba(255,255,255,.35);
        --focus: #7873f5;
      }
      .dark:root{
        --glass-bg: rgba(17, 24, 39, .35);
        --glass-stroke: rgba(255,255,255,.14);
        --glass-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
        --chip-stroke: rgba(255,255,255,.18);
        --focus: #8b5cf6;
      }

      body{
        background:
          radial-gradient(1200px 600px at 10% -10%, rgba(120,115,245,.18), transparent 60%),
          radial-gradient(1000px 700px at 110% 20%, rgba(236,72,153,.14), transparent 60%),
          radial-gradient(900px 600px at 50% 120%, rgba(34,197,94,.10), transparent 60%),
          linear-gradient(180deg, #0b1020 0%, #0b0f1a 60%, #0a0d18 100%);
        min-height: 100vh;
        color: #0f172a;
      }
      .dark body{
        color: #e5e7eb;
      }
      .bg-noise{
        position: fixed; inset: -10vmax;
        pointer-events: none;
        background-image: url("data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 220 220'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 .035 .08 .12 .08 .035 0 0'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>");
        opacity:.35;
        mix-blend-mode: soft-light;
      }

      .glass {
        background: var(--glass-bg);
        backdrop-filter: saturate(140%) blur(16px);
        -webkit-backdrop-filter: saturate(140%) blur(16px);
        border: 1px solid var(--glass-stroke);
        box-shadow: var(--glass-shadow);
      }
      .glass-hover:hover{
        background: rgba(255,255,255,.22);
      }
      .dark .glass-hover:hover{
        background: rgba(17,24,39,.45);
      }
      .card{
        border-radius: 18px;
        background: var(--glass-bg);
        backdrop-filter: blur(14px) saturate(140%);
        -webkit-backdrop-filter: blur(14px) saturate(140%);
        border: 1px solid var(--glass-stroke);
        box-shadow: var(--glass-shadow);
        transition: transform .18s ease, background .2s ease, box-shadow .2s ease;
      }
      .card:hover{ transform: translateY(-2px); }

      .chip{
        padding:.55rem .9rem;
        border-radius: 999px;
        border: 1px solid var(--chip-stroke);
        background: linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.14));
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .dark .chip{
        background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      }
      .chip.active{
        background: linear-gradient(180deg, rgba(120,115,245,.28), rgba(120,115,245,.14));
        border-color: rgba(120,115,245,.45);
        color: #fff;
        text-shadow: 0 1px 0 rgba(0,0,0,.2);
      }

      .stat-card{
        padding:1.25rem;border-radius:18px;
        background: linear-gradient(160deg, rgba(120,115,245,.22) 0%, rgba(120,115,245,.06) 100%);
        border: 1px solid rgba(120,115,245,.35);
        box-shadow: 0 10px 30px rgba(120,115,245,.12), inset 0 0 0 1px rgba(255,255,255,.08);
      }
      .dark .stat-card{
        background: linear-gradient(160deg, rgba(120,115,245,.25) 0%, rgba(120,115,245,.10) 100%);
        border-color: rgba(120,115,245,.35);
      }

    .metric-badge{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.3rem .65rem;border-radius:999px;font-size:.75rem;font-weight:600;
      background: linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,.08));
      border: 1px solid var(--chip-stroke);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
    }
    .badge-views{ background: linear-gradient(180deg, rgba(251,191,36,.35), rgba(251,191,36,.16)); border-color: rgba(251,191,36,.45); color:#fef3c7; }
    .badge-likes{ background: linear-gradient(180deg, rgba(248,113,113,.38), rgba(248,113,113,.18)); border-color: rgba(248,113,113,.45); color:#fee2e2; }
    .badge-comments{ background: linear-gradient(180deg, rgba(129,140,248,.35), rgba(129,140,248,.16)); border-color: rgba(129,140,248,.5); color:#e0e7ff; }
    .badge-shares{ background: linear-gradient(180deg, rgba(52,211,153,.35), rgba(52,211,153,.16)); border-color: rgba(16,185,129,.5); color:#d1fae5; }
    .badge-plays{ background: linear-gradient(180deg, rgba(192,132,252,.35), rgba(192,132,252,.16)); border-color: rgba(168,85,247,.5); color:#ede9fe; }

      @keyframes spin{to{transform:rotate(360deg)}}
      .spinner{width:16px;height:16px;border-radius:999px;border:2px solid transparent;border-top-color:currentColor;animation:spin .8s linear infinite}

      @keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      .animate-slide-up{animation:slideUp .3s ease-out}

      .glassbar{
        position: sticky; top: 0; z-index: 40;
        margin: 10px auto 0;
        border-radius: 20px;
        padding: .75rem 1rem;
        max-width: 74rem;
        border: 1px solid var(--glass-stroke);
        background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
        backdrop-filter: blur(14px) saturate(140%);
        -webkit-backdrop-filter: blur(14px) saturate(140%);
        box-shadow: var(--glass-shadow);
      }
      .dark .glassbar{
        background: linear-gradient(180deg, rgba(17,24,39,.55), rgba(17,24,39,.35));
      }

      .glass-input{
        border-radius: 14px; padding: .9rem 1rem;
        background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.12));
        border: 1px solid var(--glass-stroke);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        outline: none;
        transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
      }
      .glass-input:focus{
        border-color: color-mix(in oklab, var(--focus) 60%, white 40%);
        box-shadow: 0 0 0 4px color-mix(in oklab, var(--focus) 25%, transparent 75%);
        background: linear-gradient(180deg, rgba(255,255,255,.32), rgba(255,255,255,.18));
      }
      .dark .glass-input{
        background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      }

      .cta{
        border-radius: 14px; padding:.9rem 1.1rem; font-weight:700;
        background: linear-gradient(100deg, rgba(120,115,245,.95), rgba(147,51,234,.9));
        color:#fff; box-shadow: 0 12px 30px rgba(120,115,245,.35);
        border: 1px solid rgba(255,255,255,.28);
        transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
      }
      .cta:hover{ transform: translateY(-1px); box-shadow: 0 16px 34px rgba(120,115,245,.45); filter: brightness(1.02); }
      .cta:disabled{ opacity:.6; transform:none; box-shadow:none; filter:none; }

      .progress-outer{
        height:10px;border-radius:999px;overflow:hidden;
        background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
        border: 1px solid var(--glass-stroke);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .progress-inner{
        height:100%; background: linear-gradient(90deg, #7873f5, #9333ea);
        box-shadow: inset 0 0 12px rgba(255,255,255,.35);
      }

      .blob{
        position:absolute; filter: blur(40px); opacity:.55; mix-blend-mode: screen;
        pointer-events:none; z-index:0;
      }
      .blob1{ width:420px; height:420px; background: radial-gradient(closest-side, rgba(120,115,245,.55), transparent 70%); top:-80px; left:-80px; }
      .blob2{ width:380px; height:380px; background: radial-gradient(closest-side, rgba(236,72,153,.45), transparent 70%); bottom:-60px; right:-60px; }
      .blob3{ width:320px; height:320px; background: radial-gradient(closest-side, rgba(34,197,94,.40), transparent 70%); top:40%; right:15%; }

      @media (max-width: 640px){
        .glassbar{
          padding: .6rem .85rem;
          margin: 6px auto 0;
        }
        .card{ border-radius: 16px; }
        .stat-card{ border-radius: 16px; }
      }

      @media (prefers-color-scheme: dark){
        .chart-tick{ color: #9ca3af !important; }
      }
    </style>
  </head>
  <body class="text-gray-900 dark:text-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo, useRef } = React;

      const TYPE_ORDER = ['LinkedIn','Instagram','TikTok','YouTube','Blog'];
      const ALL_TYPES = [...TYPE_ORDER];
      const BADGE_CLASSES = {
        LinkedIn: 'bg-blue-500/15 text-blue-200 ring-1 ring-inset ring-white/10',
        Instagram: 'bg-pink-500/15 text-pink-200 ring-1 ring-inset ring-white/10',
        TikTok: 'bg-purple-500/15 text-purple-200 ring-1 ring-inset ring-white/10',
        YouTube: 'bg-red-500/15 text-red-200 ring-1 ring-inset ring-white/10',
        Blog: 'bg-emerald-500/15 text-emerald-200 ring-1 ring-inset ring-white/10',
      };
      const ICON_BY_TYPE = {
        LinkedIn: '🔷',
        Instagram: '📸',
        TikTok: '🎵',
        YouTube: '▶️',
        Blog: '📝',
      };
      const SOURCE_ICON = {
        rss: '📰',
        linkedin: '🔷',
        youtube: '▶️',
        instagram: '📸',
        tiktok: '🎵',
      };
      const SOURCE_PRESETS = {
        Gratuit: new Set(['rss','youtube','linkedin']),
        Réseaux: new Set(['linkedin','instagram','tiktok','youtube']),
        Tout: new Set(['rss','linkedin','instagram','tiktok','youtube']),
      };
      const DAY_PRESETS = [
        { label: '7j', value: 7 },
        { label: '14j', value: 14 },
        { label: '30j', value: 30 },
        { label: 'Tout', value: 'all' },
      ];
      const ALLOWED_SOURCES = ['rss','linkedin','youtube','instagram','tiktok'];

      const cls = (...values) => values.filter(Boolean).join(' ');

      const normalizeSource = (value) => {
        const parsed = String(value ?? '')
          .replace(/[\[\]\s"']/g, '')
          .trim()
          .toLowerCase();
        return ALLOWED_SOURCES.includes(parsed) ? parsed : null;
      };

      const loadSourcesFromStorage = () => {
        const raw = localStorage.getItem('rivalytics:sources');
        if (!raw) return new Set(ALLOWED_SOURCES);
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            const clean = parsed.map(normalizeSource).filter(Boolean);
            return new Set(clean.length ? clean : ALLOWED_SOURCES);
          }
        } catch {
          // ignore malformed json
        }
        const clean = raw.split(',').map(normalizeSource).filter(Boolean);
        return new Set(clean.length ? clean : ALLOWED_SOURCES);
      };

      const slugifyNameToHandle = (name = '') =>
        String(name)
          .normalize('NFKD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-zA-Z0-9._]+/g, '')
          .toLowerCase();

      const toLinkedInSlug = (value = '') =>
        String(value)
          .normalize('NFKD')
          .replace(/[\u0300-\u036f]/g, '')
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .replace(/--+/g, '-');

      const toDaysParam = (value) => {
        if (value === 'all') return 3650;
        const numeric = typeof value === 'number' ? value : Number(value);
        return Number.isFinite(numeric) && numeric > 0 ? numeric : 30;
      };

      const dedupeByUrl = (items) => {
        const seen = new Set();
        return items.filter((item) => {
          if (!item.url) return true;
          if (seen.has(item.url)) return false;
          seen.add(item.url);
          return true;
        });
      };

      const scoreItem = (item) =>
        (item.metrics?.likes ?? 0) +
        (item.metrics?.views ?? 0) +
        (item.metrics?.comments ?? 0) +
        (item.metrics?.shares ?? 0) +
        (item.metrics?.plays ?? 0);

      function Badge({ kind }) {
        return (
          <span className={cls('px-2 py-0.5 rounded-full text-xs font-semibold', BADGE_CLASSES[kind])}>
            {kind}
          </span>
        );
      }

      function CompanyCard({ company }) {
        if (!company) return null;
        let hostname = null;
        if (company.site) {
          try { hostname = new URL(company.site).hostname; } catch { hostname = company.site; }
        }
        return (
          <div className="card p-4 sm:p-5 flex flex-col sm:flex-row items-start sm:items-center gap-4">
            {company.logo && (
              <img
                src={company.logo}
                alt={company.name ?? 'Logo entreprise'}
                className="w-16 h-16 rounded-2xl object-cover ring-1 ring-white/20 self-center sm:self-auto"
              />
            )}
            <div className="flex-1">
              <div className="flex items-center gap-2">
                <h3 className="text-lg font-semibold">{company.name}</h3>
                <Badge kind="LinkedIn" />
              </div>
              {company.slogan && (
                <div className="text-sm text-gray-200/80 dark:text-gray-300/80">{company.slogan}</div>
              )}
              <div className="text-xs text-gray-300/80 mt-1">
                {company.locality ?? ''}
                {company.country ? `${company.locality ? ', ' : ''}${company.country}` : ''}
                {hostname && (
                  <>
                    <span className="mx-2">·</span>
                    <a
                      className="underline decoration-white/30 hover:decoration-white"
                      href={company.site ?? '#'}
                      target="_blank"
                      rel="noreferrer"
                    >
                      {hostname}
                    </a>
                  </>
                )}
                {Number.isFinite(company.employees) && (
                  <>
                    <span className="mx-2">·</span>
                    {Number(company.employees ?? 0).toLocaleString('fr-FR')} employés
                  </>
                )}
              </div>
            </div>
          </div>
        );
      }

      function MetricBadges({ metrics }) {
        const hasValue = (value) => Number(value ?? 0) > 0;
        if (
          !hasValue(metrics?.likes) &&
          !hasValue(metrics?.views) &&
          !hasValue(metrics?.comments) &&
          !hasValue(metrics?.shares) &&
          !hasValue(metrics?.plays)
        ) {
          return null;
        }
        return (
          <div className="mt-3 flex flex-wrap gap-2 text-sm">
            {hasValue(metrics?.views) && (
              <span className="metric-badge badge-views">👁️ {Number(metrics.views).toLocaleString('fr-FR')}</span>
            )}
            {hasValue(metrics?.likes) && (
              <span className="metric-badge badge-likes">❤ {Number(metrics.likes).toLocaleString('fr-FR')}</span>
            )}
            {hasValue(metrics?.comments) && (
              <span className="metric-badge badge-comments">💬 {Number(metrics.comments).toLocaleString('fr-FR')}</span>
            )}
            {hasValue(metrics?.shares) && (
              <span className="metric-badge badge-shares">🔁 {Number(metrics.shares).toLocaleString('fr-FR')}</span>
            )}
            {hasValue(metrics?.plays) && (
              <span className="metric-badge badge-plays">▶ {Number(metrics.plays).toLocaleString('fr-FR')}</span>
            )}
          </div>
        );
      }

      function ResultItem({ item }) {
        const safeDate = item.date ? new Date(item.date) : null;
        const dateLabel =
          safeDate && !Number.isNaN(safeDate.valueOf())
            ? safeDate.toLocaleDateString('fr-FR')
            : '—';
        return (
          <a
            href={item.url}
            target="_blank"
            rel="noreferrer"
            className="card block p-4 transition glass-hover"
          >
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="mr-1">{ICON_BY_TYPE[item.type] ?? '🔗'}</span>
                <Badge kind={item.type} />
              </div>
              <span className="text-xs text-gray-300/80">{dateLabel}</span>
            </div>
            <h3 className="mt-2 font-medium line-clamp-2">{item.title}</h3>
            <MetricBadges metrics={item.metrics ?? {}} />
          </a>
        );
      }

      function SkeletonCard() {
        return (
          <div className="card p-4 animate-pulse">
            <div className="flex justify-between">
              <div className="h-5 w-20 bg-white/20 rounded" />
              <div className="h-4 w-24 bg-white/20 rounded" />
            </div>
            <div className="h-6 w-4/5 bg-white/20 rounded mt-3" />
            <div className="h-4 w-24 bg-white/20 rounded mt-4" />
          </div>
        );
      }

      function StatCard({ title, value, subtitle, icon }) {
        return (
          <div className="stat-card p-4 sm:p-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-2xl">{icon}</span>
            </div>
            <div className="text-2xl sm:text-3xl font-extrabold drop-shadow">
              {typeof value === 'number' ? value.toLocaleString('fr-FR') : value}
            </div>
            <div className="text-sm text-gray-200/90 mt-1">{title}</div>
            {subtitle && <div className="text-xs text-gray-300/80 mt-2">{subtitle}</div>}
          </div>
        );
      }

      function ProgressBar({ value, max }) {
        const ratio = Math.round(((value || 0) / Math.max(max || 1, 1)) * 100) || 0;
        return (
          <div className="progress-outer">
            <div className="progress-inner" style={{ width: `${ratio}%` }} />
          </div>
        );
      }

      function StatusPill({ source, status }) {
        const classes = {
          pending: 'border-indigo-400/40 text-indigo-200',
          done: 'border-emerald-400/40 text-emerald-200',
          empty: 'border-white/20 text-white/70',
          error: 'border-rose-400/40 text-rose-300',
          idle: 'border-white/20 text-white/70',
        };
        return (
          <span className={cls('px-3 py-1 rounded-full text-[11px] sm:text-xs border inline-flex items-center gap-2 glass', classes[status] ?? classes.idle)}>
            <span>{SOURCE_ICON[source] ?? '•'}</span>
            {status === 'pending' ? <span className="spinner" /> : <span className="text-xs">·</span>}
            <span className="font-medium">{source.toUpperCase()}</span>
          </span>
        );
      }

      function EngagementChart({ data, dark }) {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
          if (!canvasRef.current) return undefined;
          if (chartRef.current) chartRef.current.destroy();
          const ctx = canvasRef.current.getContext('2d');
          if (!ctx) return undefined;

          const labels = TYPE_ORDER;
          const values = labels.map((key) => data[key] || 0);

          chartRef.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Engagement total',
                data: values,
                backgroundColor: [
                  'rgba(120,115,245,.45)',
                  'rgba(236,72,153,.40)',
                  'rgba(147,51,234,.42)',
                  'rgba(239,68,68,.42)',
                  'rgba(34,197,94,.40)',
                ],
                borderColor: [
                  'rgba(120,115,245,1)',
                  'rgba(236,72,153,1)',
                  'rgba(147,51,234,1)',
                  'rgba(239,68,68,1)',
                  'rgba(34,197,94,1)',
                ],
                borderWidth: 1.2,
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx) => `${ctx.parsed.y.toLocaleString('fr-FR')} interactions`,
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: dark ? 'rgba(255,255,255,.14)' : 'rgba(255,255,255,.22)' },
                  ticks: { color: dark ? '#cbd5e1' : '#e5e7eb' },
                },
                x: {
                  grid: { display: false },
                  ticks: { color: dark ? '#cbd5e1' : '#e5e7eb' },
                },
              },
            },
          });

          return () => chartRef.current && chartRef.current.destroy();
        }, [data, dark]);

        return <canvas ref={canvasRef} />;
      }

      function TimelineChart({ data, dark }) {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
          if (!canvasRef.current) return undefined;
          if (chartRef.current) chartRef.current.destroy();
          const ctx = canvasRef.current.getContext('2d');
          if (!ctx) return undefined;

          const grouped = new Map();
          data.forEach((item) => {
            if (!item.date) return;
            grouped.set(item.date, (grouped.get(item.date) ?? 0) + 1);
          });
          const labelsISO = Array.from(grouped.keys()).sort();
          const values = labelsISO.map((key) => grouped.get(key) ?? 0);

          chartRef.current = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labelsISO.map((value) =>
                new Date(value).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })
              ),
              datasets: [{
                label: 'Publications',
                data: values,
                fill: true,
                backgroundColor: 'rgba(120,115,245,.18)',
                borderColor: 'rgba(120,115,245,1)',
                borderWidth: 1.5,
                tension: 0.35,
                pointRadius: 2,
                pointBackgroundColor: 'rgba(255,255,255,.9)',
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: dark ? 'rgba(255,255,255,.14)' : 'rgba(255,255,255,.22)' },
                  ticks: { color: dark ? '#cbd5e1' : '#e5e7eb', stepSize: 1 },
                },
                x: {
                  grid: { display: false },
                  ticks: { color: dark ? '#cbd5e1' : '#e5e7eb' },
                },
              },
            },
          });

          return () => chartRef.current && chartRef.current.destroy();
        }, [data, dark]);

        return <canvas ref={canvasRef} />;
      }

      function App() {
        const [dark, setDark] = useState(() => localStorage.getItem('theme') === 'dark');
        useEffect(() => {
          document.documentElement.classList.toggle('dark', dark);
          localStorage.setItem('theme', dark ? 'dark' : 'light');
        }, [dark]);

        const [tab, setTab] = useState('search');
        const [name, setName] = useState(() => localStorage.getItem('rivalytics:lastName') || '');
        const [days, setDays] = useState(() => {
          const stored = localStorage.getItem('rivalytics:days');
          if (stored === 'all') return 'all';
          const parsed = Number(stored);
          return Number.isFinite(parsed) && parsed > 0 ? parsed : 30;
        });

        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [note, setNote] = useState(null);
        const [allResults, setAllResults] = useState([]);
        const [company, setCompany] = useState(null);

        const [types, setTypes] = useState(() => new Set(ALL_TYPES));
        const [sources, setSources] = useState(loadSourcesFromStorage);
        const initialStatuses = { rss:'idle', linkedin:'idle', youtube:'idle', instagram:'idle', tiktok:'idle' };
        const [statuses, setStatuses] = useState(initialStatuses);

        const abortRef = useRef(null);
        const inputRef = useRef(null);

        useEffect(() => { inputRef.current?.focus(); }, []);
        useEffect(() => { localStorage.setItem('rivalytics:lastName', name); }, [name]);
        useEffect(() => { localStorage.setItem('rivalytics:days', String(days)); }, [days]);
        useEffect(() => { localStorage.setItem('rivalytics:sources', JSON.stringify(Array.from(sources))); }, [sources]);

        const toggleType = (type) => {
          setTypes((prev) => {
            const next = new Set(prev);
            if (next.has(type)) next.delete(type);
            else next.add(type);
            if (next.size === 0) next.add('Blog');
            return next;
          });
        };

        const toggleSource = (source) => {
          setSources((prev) => {
            const next = new Set(prev);
            if (next.has(source)) next.delete(source);
            else next.add(source);
            if (next.size === 0) next.add('rss');
            return next;
          });
        };

        const applyPreset = (label) => {
          const preset = SOURCE_PRESETS[label];
          if (preset) setSources(new Set(preset));
        };

        const updateStatus = (source, status) => {
          setStatuses((prev) => ({ ...prev, [source]: status }));
        };

        const pushResults = (items = []) => {
          if (!Array.isArray(items)) return;
          setAllResults((prev) => dedupeByUrl([...prev, ...items]));
        };

        const runSearch = async () => {
          const raw = name.trim();
          if (!raw) return;

          abortRef.current?.abort();
          const controller = new AbortController();
          abortRef.current = controller;

          setLoading(true);
          setError(null);
          setNote(null);
          setAllResults([]);
          setCompany(null);
          setStatuses({
            rss: sources.has('rss') ? 'pending' : 'idle',
            linkedin: sources.has('linkedin') ? 'pending' : 'idle',
            youtube: sources.has('youtube') ? 'pending' : 'idle',
            instagram: sources.has('instagram') ? 'pending' : 'idle',
            tiktok: sources.has('tiktok') ? 'pending' : 'idle',
          });

          const lower = raw.toLowerCase();
          const handle = slugifyNameToHandle(raw);
          const daysParam = toDaysParam(days);
          const signal = controller.signal;
          const pending = [];

          const wrap = (source, request) =>
            request
              .then((res) => {
                if (!res.ok) throw new Error('http_error');
                return res.json();
              })
              .then((json) => {
                if (json.company) setCompany(json.company);
                if (Array.isArray(json.items)) pushResults(json.items);
                if (json.note) setNote(json.note);
                updateStatus(source, Array.isArray(json.items) && json.items.length > 0 ? 'done' : 'empty');
              })
              .catch((err) => {
                if (err?.name === 'AbortError') return;
                updateStatus(source, 'error');
              });

          if (sources.has('linkedin')) {
            const url = new URL('/api/linkedin', window.location.origin);
            url.searchParams.set('slug', toLinkedInSlug(raw));
            url.searchParams.set('days', String(daysParam));
            url.searchParams.set('limit', '20');
            pending.push(wrap('linkedin', fetch(url, { signal })));
          }
          if (sources.has('rss')) {
            const url = new URL('/api/rss', window.location.origin);
            url.searchParams.set('name', lower);
            url.searchParams.set('days', String(daysParam));
            pending.push(wrap('rss', fetch(url, { signal })));
          }
          if (sources.has('instagram')) {
            const url = new URL('/api/instagram', window.location.origin);
            url.searchParams.set('username', handle);
            url.searchParams.set('limit', '12');
            pending.push(wrap('instagram', fetch(url, { signal })));
          }
          if (sources.has('tiktok')) {
            const url = new URL('/api/tiktok', window.location.origin);
            url.searchParams.set('username', handle);
            url.searchParams.set('limit', '12');
            pending.push(wrap('tiktok', fetch(url, { signal })));
          }
          if (sources.has('youtube')) {
            const url = new URL('/api/youtube', window.location.origin);
            url.searchParams.set('q', raw);
            url.searchParams.set('days', String(daysParam));
            url.searchParams.set('limit', '12');
            pending.push(wrap('youtube', fetch(url, { signal })));
          }

          Promise.allSettled(pending).then(() => {
            setLoading(false);
            abortRef.current = null;
            setAllResults((prev) => {
              if (prev.length === 0) setError('Aucune donnée récente trouvée.');
              return prev;
            });
          });
        };

        const cancelSearch = () => {
          abortRef.current?.abort();
          abortRef.current = null;
          setLoading(false);
          setStatuses((prev) => {
            const next = { ...prev };
            Object.keys(next).forEach((key) => {
              if (next[key] === 'pending') next[key] = 'error';
            });
            return next;
          });
        };

        const filtered = useMemo(
          () => allResults.filter((item) => types.has(item.type)),
          [allResults, types]
        );

        const grouped = useMemo(() => {
          const map = {};
          TYPE_ORDER.forEach((type) => { map[type] = []; });
          filtered.forEach((item) => {
            if (!map[item.type]) map[item.type] = [];
            map[item.type].push(item);
          });
          Object.keys(map).forEach((key) => {
            map[key] = map[key].sort((a, b) => {
              if (!a.date) return 1;
              if (!b.date) return -1;
              return a.date < b.date ? 1 : -1;
            });
          });
          return map;
        }, [filtered]);

        const stats = useMemo(() => {
          const totalEngagement = filtered.reduce((acc, item) => acc + scoreItem(item), 0);
          const engagementByType = {};
          TYPE_ORDER.forEach((type) => {
            engagementByType[type] = (grouped[type] ?? []).reduce((acc, item) => acc + scoreItem(item), 0);
          });
          const avgEngagement = filtered.length ? Math.round(totalEngagement / filtered.length) : 0;
          const topContent = [...filtered].sort((a, b) => scoreItem(b) - scoreItem(a))[0];
          const daysSet = new Set(filtered.map((item) => item.date).filter(Boolean));
          const pubFreq = daysSet.size ? (filtered.length / daysSet.size).toFixed(1) : '0';
          return { total: filtered.length, totalEngagement, avgEngagement, engagementByType, topContent, pubFreq, uniqueDays: daysSet.size };
        }, [filtered, grouped]);

        const activeSources = useMemo(() => Array.from(sources), [sources]);
        const totalJobs = activeSources.length;
        const doneCount = activeSources.filter((src) => ['done','empty','error'].includes(statuses[src])).length;
        const anyPending = activeSources.some((src) => statuses[src] === 'pending');

        return (
          <div className="min-h-screen relative z-10">
            <div className="bg-noise" />
            <div className="blob blob1" />
            <div className="blob blob2" />
            <div className="blob blob3" />

            <header className="px-3 sm:px-6">
              <div className="glassbar">
                <div className="max-w-7xl mx-auto flex items-center justify-between">
                  <div className="relative">
                    <h1 className="text-2xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 via-fuchsia-300 to-emerald-300 drop-shadow">
                      Rivalytics
                    </h1>
                    <p className="text-xs text-white/70 mt-0.5">Analyse concurrentielle multi-plateformes</p>
                  </div>
                  <div className="flex items-center gap-2 flex-wrap sm:flex-nowrap justify-end">
                    <button onClick={() => setTab('dashboard')} className={cls('chip flex items-center justify-center', tab === 'dashboard' && 'active')}>📊 Dashboard</button>
                    <button onClick={() => setTab('search')} className={cls('chip flex items-center justify-center', tab === 'search' && 'active')}>🔍 Recherche</button>
                    <button onClick={() => setDark((prev) => !prev)} className="chip flex items-center justify-center" title="Basculer thème">
                      {dark ? '🌞' : '🌙'}
                    </button>
                  </div>
                </div>
              </div>
            </header>

            <main className="max-w-7xl mx-auto px-4 sm:px-6 py-6">
              <form
                onSubmit={(event) => { event.preventDefault(); runSearch(); }}
                className="flex flex-col sm:flex-row gap-3 mb-6 w-full"
              >
                <input
                  ref={inputRef}
                  value={name}
                  onChange={(event) => setName(event.target.value)}
                  placeholder="Nom du concurrent (ex: Accenture, Dev First...)"
                  className="glass-input flex-1 w-full text-white placeholder:text-white/60"
                />
                <div className="flex gap-2 flex-wrap sm:flex-nowrap">
                  {DAY_PRESETS.map((preset) => (
                    <button
                      type="button"
                      key={preset.label}
                      onClick={() => setDays(preset.value)}
                      className={cls('chip text-sm w-full sm:w-auto flex items-center justify-center', String(days) === String(preset.value) && 'active')}
                    >
                      {preset.label}
                    </button>
                  ))}
                </div>
                <div className="flex items-center gap-2 flex-wrap sm:flex-nowrap">
                  <button type="submit" disabled={loading || !name.trim()} className="cta w-full sm:w-auto flex items-center justify-center">
                    {loading ? '⏳ Analyse...' : '🚀 Analyser'}
                  </button>
                  {loading && (
                    <button
                      type="button"
                      onClick={cancelSearch}
                      className="chip text-rose-200 border-rose-300/30 hover:brightness-110 w-full sm:w-auto flex items-center justify-center"
                      title="Annuler la recherche en cours"
                    >
                      ✖ Annuler
                    </button>
                  )}
                </div>
              </form>

              <div className="card p-4 sm:p-5 mb-6">
                <div className="flex items-center gap-3 flex-wrap">
                  <span className="text-sm font-medium text-white/90">Sources :</span>
                  {ALLOWED_SOURCES.map((source) => (
                    <button
                      key={source}
                      onClick={() => toggleSource(source)}
                      className={cls('chip text-sm w-full sm:w-auto flex items-center justify-center', sources.has(source) && 'active')}
                    >
                      {SOURCE_ICON[source]} {source.toUpperCase()}
                    </button>
                  ))}
                  <div className="ml-auto flex gap-2 flex-wrap sm:flex-nowrap">
                    {Object.keys(SOURCE_PRESETS).map((label) => (
                      <button key={label} onClick={() => applyPreset(label)} className="chip text-sm w-full sm:w-auto flex items-center justify-center">
                        {label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {note && (
                <div className="card p-4 sm:p-5 mb-6 border-indigo-400/40 text-indigo-100 text-sm">
                  {note}
                </div>
              )}

              {error && (
                <div className="card p-4 sm:p-5 mb-6 border-amber-400/40">
                  <span className="text-amber-200">⚠️ {error}</span>
                </div>
              )}

              {tab === 'search' && (
                <div className="space-y-6">
                  {company && (
                    <div>
                      <h2 className="text-lg font-semibold mb-3">Entreprise analysée</h2>
                      <CompanyCard company={company} />
                    </div>
                  )}

                  {(loading || anyPending) && (
                    <div className="card p-4 sm:p-5 animate-slide-up">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <span className="spinner text-indigo-300" />
                          <span className="font-medium">Collecte en cours…</span>
                        </div>
                        <div className="text-sm text-white/70">{doneCount}/{Math.max(totalJobs, 1)}</div>
                      </div>
                      <ProgressBar value={doneCount} max={Math.max(totalJobs, 1)} />
                      <div className="mt-3 flex flex-wrap gap-2">
                        {activeSources.map((source) => (
                          <StatusPill key={source} source={source} status={statuses[source]} />
                        ))}
                      </div>
                    </div>
                  )}

                  {!loading && (
                    <div className="space-y-2">
                      <div className="flex items-baseline gap-2 flex-wrap">
                        <span className="text-3xl font-semibold tracking-tight drop-shadow">
                          {filtered.length}
                        </span>
                        <span className="text-base text-white/80">
                          contenus publiés {days === 'all' ? 'au total' : `sur les ${days} derniers jours`}
                        </span>
                      </div>

                      {/* [FIX] Boutons de type compatibles dark en réutilisant .chip */}
                      <div className="flex items-center gap-2 flex-wrap mt-1">
                        {TYPE_ORDER.filter((type) => (grouped[type] ?? []).length).map((type) => (
                          <button
                            key={type}
                            type="button"
                            onClick={() => toggleType(type)}
                            className={cls(
                              'chip inline-flex items-center gap-2',
                              types.has(type) && 'active'
                            )}
                            title={`${type} • ${(grouped[type] ?? []).length}`}
                          >
                            <span className="text-base leading-none">{ICON_BY_TYPE[type]}</span>
                            <span className={cls('px-2 py-0.5 rounded-full text-xs font-semibold', BADGE_CLASSES[type])}>
                              {type}
                            </span>
                            <span className="text-xs rounded-md px-1.5 py-0.5 bg-white/10 text-white/90">
                              {(grouped[type] ?? []).length}
                            </span>
                          </button>
                        ))}
                      </div>
                    </div>
                  )}

                  {loading && filtered.length === 0 && (
                    <div role="status" aria-live="polite" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Array.from({ length: 6 }).map((_, index) => <SkeletonCard key={index} />)}
                    </div>
                  )}

                  {TYPE_ORDER.filter((type) => (grouped[type] ?? []).length).map((type) => (
                    <div key={type} className="space-y-3">
                      <div className="flex items-center gap-2">
                        <span className="text-xl font-semibold">{ICON_BY_TYPE[type]}</span>
                        <h2 className="text-xl font-semibold">{type}</h2>
                        <span className="text-sm text-white/70">({(grouped[type] ?? []).length})</span>
                      </div>
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {(grouped[type] ?? []).map((item) => (
                          <ResultItem key={item.id} item={item} />
                        ))}
                      </div>
                    </div>
                  ))}

                  {loading && (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Array.from({ length: 6 }).map((_, index) => <SkeletonCard key={index} />)}
                    </div>
                  )}

                  {!loading && filtered.length === 0 && (
                    <div className="text-white/80 text-sm">Aucun résultat pour ces filtres.</div>
                  )}
                </div>
              )}

              {tab === 'dashboard' && (
                <div className="space-y-6 animate-slide-up">
                  {company && (
                    <div>
                      <h2 className="text-lg font-semibold mb-3">Entreprise analysée</h2>
                      <CompanyCard company={company} />
                    </div>
                  )}

                  {(loading || anyPending) && (
                    <div className="card p-4 sm:p-5 animate-slide-up">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <span className="spinner text-indigo-300" />
                          <span className="font-medium">Collecte en cours…</span>
                        </div>
                        <div className="text-sm text-white/70">{doneCount}/{Math.max(totalJobs, 1)}</div>
                      </div>
                      <ProgressBar value={doneCount} max={Math.max(totalJobs, 1)} />
                      <div className="mt-3 flex flex-wrap gap-2">
                        {activeSources.map((source) => (
                          <StatusPill key={source} source={source} status={statuses[source]} />
                        ))}
                      </div>
                    </div>
                  )}

                  {filtered.length > 0 ? (
                    <>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Publications totales" value={stats.total} subtitle={`${stats.uniqueDays} jours actifs`} icon="📈" />
                        <StatCard title="Engagement total" value={stats.totalEngagement} subtitle="Likes, vues, comments, shares" icon="💬" />
                        <StatCard title="Engagement moyen" value={stats.avgEngagement} subtitle="Par publication" icon="⭐" />
                        <StatCard title="Fréquence" value={stats.pubFreq} subtitle="Publications/jour" icon="📅" />
                      </div>

                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="card p-4 sm:p-6">
                          <h3 className="font-semibold mb-4">📊 Engagement par plateforme</h3>
                          <div style={{ height: '250px' }}><EngagementChart data={stats.engagementByType} dark={dark} /></div>
                        </div>
                        <div className="card p-4 sm:p-6">
                          <h3 className="font-semibold mb-4">📈 Timeline des publications</h3>
                          <div style={{ height: '250px' }}><TimelineChart data={filtered} dark={dark} /></div>
                        </div>
                      </div>

                      {stats.topContent && (
                        <div className="card p-4 sm:p-6">
                          <h3 className="font-semibold mb-4">🏆 Contenu le plus performant</h3>
                          <div className="flex items-start gap-4">
                            <div className="text-3xl">{ICON_BY_TYPE[stats.topContent.type]}</div>
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-2">
                                <Badge kind={stats.topContent.type} />
                                <span className="text-sm text-white/70">
                                  {stats.topContent.date ? new Date(stats.topContent.date).toLocaleDateString('fr-FR') : '—'}
                                </span>
                              </div>
                              <h4 className="font-medium mb-2">{stats.topContent.title}</h4>
                              <MetricBadges metrics={stats.topContent.metrics ?? {}} />
                              <a
                                href={stats.topContent.url}
                                target="_blank"
                                rel="noreferrer"
                                className="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-fuchsia-600 text-white hover:brightness-110 mt-2 border border-white/20"
                              >
                                Ouvrir le post ↗
                              </a>
                            </div>
                          </div>
                        </div>
                      )}

                      <section className="mt-6">
                        <h3 className="text-lg font-semibold mb-3">Tous les contenus ({filtered.length})</h3>

                        {/* [FIX] Même correction ici pour les filtres par type */}
                        {TYPE_ORDER.filter((type) => (grouped[type] ?? []).length).map((type) => (
                          <div key={type} className="space-y-3 mb-5">
                            <div className="flex items-center gap-2">
                              <span className="text-xl font-semibold">{ICON_BY_TYPE[type]}</span>
                              <h4 className="text-lg font-semibold">{type}</h4>
                              <span className="text-sm text-white/70">({(grouped[type] ?? []).length})</span>
                              <div className="ml-2">
                                <button
                                  type="button"
                                  onClick={() => toggleType(type)}
                                  className={cls('chip inline-flex items-center gap-2', types.has(type) && 'active')}
                                  title={`${type} • ${(grouped[type] ?? []).length}`}
                                >
                                  <span className="text-base leading-none">{ICON_BY_TYPE[type]}</span>
                                  <span className={cls('px-2 py-0.5 rounded-full text-xs font-semibold', BADGE_CLASSES[type])}>
                                    {type}
                                  </span>
                                  <span className="text-xs rounded-md px-1.5 py-0.5 bg-white/10 text-white/90">
                                    {(grouped[type] ?? []).length}
                                  </span>
                                </button>
                              </div>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                              {(grouped[type] ?? []).map((item) => (
                                <ResultItem key={item.id} item={item} />
                              ))}
                            </div>
                          </div>
                        ))}
                      </section>
                    </>
                  ) : (
                    !loading && <div className="text-sm text-white/80">Lance une recherche pour afficher le dashboard.</div>
                  )}

                  {loading && (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Array.from({ length: 6 }).map((_, index) => <SkeletonCard key={index} />)}
                    </div>
                  )}
                </div>
              )}

        <footer className="mt-12 text-xs text-white/70 text-center sm:text-left">
                Données <b>réelles</b> via RSS & YouTube + LinkedIn (public “guest”). Instagram & TikTok via Apify (optionnel).
              </footer>
            </main>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>