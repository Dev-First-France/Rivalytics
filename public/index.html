<!doctype html>
<html lang="fr" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rivalytics - Dashboard</title>
    <link rel="icon" href="/favicon-v2.ico" />
    <meta name="theme-color" content="#0b0f1a" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2LR661Q5S2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-2LR661Q5S2');
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root{
        --glass-bg: rgba(255,255,255,.16);
        --glass-stroke: rgba(255,255,255,.35);
        --glass-shadow: 0 10px 30px rgba(2, 8, 23, .20), inset 0 0 0 1px rgba(255,255,255,.12);
        --chip-stroke: rgba(255,255,255,.35);
        --focus: #7873f5;
      }
      .dark:root{
        --glass-bg: rgba(17, 24, 39, .35);
        --glass-stroke: rgba(255,255,255,.14);
        --glass-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.06);
        --chip-stroke: rgba(255,255,255,.18);
        --focus: #8b5cf6;
      }

      /* Bloque tout débordement horizontal */
      html, body { height: 100%; overflow-x: hidden; }

      body{
        background:
          radial-gradient(1200px 600px at 10% -10%, rgba(120,115,245,.18), transparent 60%),
          radial-gradient(1000px 700px at 110% 20%, rgba(236,72,153,.14), transparent 60%),
          radial-gradient(900px 600px at 50% 120%, rgba(34,197,94,.10), transparent 60%),
          linear-gradient(180deg, #0b1020 0%, #0b0f1a 60%, #0a0d18 100%);
        min-height: 100vh;
        color: #0f172a;
      }
      .dark body{
        color: #e5e7eb;
      }
      .bg-noise{
        position: fixed; inset: -10vmax;
        pointer-events: none;
        background-image: url("data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 220 220'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0 .035 .08 .12 .08 .035 0 0'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>");
        opacity:.35;
        mix-blend-mode: soft-light;
      }

      .glass {
        background: var(--glass-bg);
        backdrop-filter: saturate(140%) blur(16px);
        -webkit-backdrop-filter: saturate(140%) blur(16px);
        border: 1px solid var(--glass-stroke);
        box-shadow: var(--glass-shadow);
      }
      .glass-hover:hover{
        background: rgba(255,255,255,.22);
      }
      .dark .glass-hover:hover{
        background: rgba(17,24,39,.45);
      }
      .card{
        border-radius: 18px;
        background: var(--glass-bg);
        backdrop-filter: blur(14px) saturate(140%);
        -webkit-backdrop-filter: blur(14px) saturate(140%);
        border: 1px solid var(--glass-stroke);
        box-shadow: var(--glass-shadow);
        transition: transform .18s ease, background .2s ease, box-shadow .2s ease;
      }
      .card:hover{ transform: translateY(-2px); }

      .chip{
        padding:.55rem .9rem;
        border-radius: 999px;
        border: 1px solid var(--chip-stroke);
        background: linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,.14));
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
      }
      .dark .chip{
        background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      }
      .chip.active{
        background: linear-gradient(180deg, rgba(120,115,245,.28), rgba(120,115,245,.14));
        border-color: rgba(120,115,245,.45);
        color: #fff;
        text-shadow: 0 1px 0 rgba(0,0,0,.2);
      }

      .stat-card{
        padding:1.25rem;border-radius:18px;
        background: linear-gradient(160deg, rgba(120,115,245,.22) 0%, rgba(120,115,245,.06) 100%);
        border: 1px solid rgba(120,115,245,.35);
        box-shadow: 0 10px 30px rgba(120,115,245,.12), inset 0 0 0 1px rgba(255,255,255,.08);
      }
      .dark .stat-card{
        background: linear-gradient(160deg, rgba(120,115,245,.25) 0%, rgba(120,115,245,.10) 100%);
        border-color: rgba(120,115,245,.35);
      }

      .metric-badge{
        display:inline-flex;align-items:center;gap:.35rem;
        padding:.3rem .65rem;border-radius:999px;font-size:.75rem;font-weight:600;
        background: linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,.08));
        border: 1px solid var(--chip-stroke);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
      }
      .badge-views{ background: linear-gradient(180deg, rgba(251,191,36,.35), rgba(251,191,36,.16)); border-color: rgba(251,191,36,.45); color:#fef3c7; }
      .badge-likes{ background: linear-gradient(180deg, rgba(248,113,113,.38), rgba(248,113,113,.18)); border-color: rgba(248,113,113,.45); color:#fee2e2; }
      .badge-comments{ background: linear-gradient(180deg, rgba(129,140,248,.35), rgba(129,140,248,.16)); border-color: rgba(129,140,248,.5); color:#e0e7ff; }
      .badge-shares{ background: linear-gradient(180deg, rgba(52,211,153,.35), rgba(52,211,153,.16)); border-color: rgba(16,185,129,.5); color:#d1fae5; }
      .badge-plays{ background: linear-gradient(180deg, rgba(192,132,252,.35), rgba(192,132,252,.16)); border-color: rgba(168,85,247,.5); color:#ede9fe; }

      @keyframes spin{to{transform:rotate(360deg)}}
      .spinner{width:16px;height:16px;border-radius:999px;border:2px solid transparent;border-top-color:currentColor;animation:spin .8s linear infinite}

      @keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
      .animate-slide-up{animation:slideUp .3s ease-out}

      .glassbar{
        position: sticky; top: 0; z-index: 40;
        margin: 10px auto 0;
        border-radius: 20px;
        padding: .75rem 1rem;
        max-width: 80rem;
        border: 1px solid var(--glass-stroke);
        background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
        backdrop-filter: blur(14px) saturate(140%);
        -webkit-backdrop-filter: blur(14px) saturate(140%);
        box-shadow: var(--glass-shadow);
      }
      .dark .glassbar{
        background: linear-gradient(180deg, rgba(17,24,39,.55), rgba(17,24,39,.35));
      }

      .glass-input{
        border-radius: 14px; padding: .9rem 1rem;
        background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.12));
        border: 1px solid var(--glass-stroke);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        outline: none;
        transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
      }
      .glass-input:focus{
        border-color: color-mix(in oklab, var(--focus) 60%, white 40%);
        box-shadow: 0 0 0 4px color-mix(in oklab, var(--focus) 25%, transparent 75%);
        background: linear-gradient(180deg, rgba(255,255,255,.32), rgba(255,255,255,.18));
      }
      .dark .glass-input{
        background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      }

      .cta{
        border-radius: 14px; padding:.9rem 1.1rem; font-weight:700;
        background: linear-gradient(100deg, rgba(120,115,245,.95), rgba(147,51,234,.9));
        color:#fff; box-shadow: 0 12px 30px rgba(120,115,245,.35);
        border: 1px solid rgba(255,255,255,.28);
        transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
      }
      .cta:hover{ transform: translateY(-1px); box-shadow: 0 16px 34px rgba(120,115,245,.45); filter: brightness(1.02); }
      .cta:disabled{ opacity:.6; transform:none; box-shadow:none; filter:none; }

      .progress-outer{
        height:10px;border-radius:999px;overflow:hidden;
        background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
        border: 1px solid var(--glass-stroke);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      .progress-inner{
        height:100%; background: linear-gradient(90deg, #7873f5, #9333ea);
        box-shadow: inset 0 0 12px rgba(255,255,255,.35);
      }

      /* Blobs en fixed : n'affectent plus la hauteur et retirent le scroll fantôme */
      .blob{
        position:fixed; filter: blur(40px); opacity:.55; mix-blend-mode: screen;
        pointer-events:none; z-index:0;
      }
      .blob1{ width:420px; height:420px; background: radial-gradient(closest-side, rgba(120,115,245,.55), transparent 70%); top:-80px; left:-80px; }
      .blob2{ width:380px; height:380px; background: radial-gradient(closest-side, rgba(236,72,153,.45), transparent 70%); bottom:-60px; right:-60px; }
      .blob3{ width:320px; height:320px; background: radial-gradient(closest-side, rgba(34,197,94,.40), transparent 70%); top:40%; right:15%; }

      @media (max-width: 640px){
        .glassbar{
          padding: .6rem .85rem;
          margin: 6px auto 0;
        }
        .card{ border-radius: 16px; }
        .stat-card{ border-radius: 16px; }
      }

      @media (prefers-color-scheme: dark){
        .chart-tick{ color: #9ca3af !important; }
      }
    </style>
  </head>
  <body class="text-gray-900 dark:text-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo, useRef, useCallback } = React;

      const TYPE_ORDER = ['LinkedIn', 'YouTube'];
      const ALL_TYPES = [...TYPE_ORDER];
      const BADGE_CLASSES = {
        LinkedIn: 'bg-blue-500/15 text-blue-200 ring-1 ring-inset ring-white/10',
        YouTube: 'bg-red-500/15 text-red-200 ring-1 ring-inset ring-white/10',
      };
      const ICON_BY_TYPE = {
        LinkedIn: '🔷',
        YouTube: '▶️',
      };
      const SOURCE_ICON = {
        linkedin: '🔷',
        youtube: '▶️',
      };
      const SOURCE_PRESETS = {
        LinkedIn: new Set(['linkedin']),
        YouTube: new Set(['youtube']),
        Réseaux: new Set(['linkedin', 'youtube']),
      };
      const DAY_PRESETS = [
        { label: '7j', value: 7 },
        { label: '14j', value: 14 },
        { label: '30j', value: 30 },
        { label: 'Tout', value: 'all' },
      ];
      const ALLOWED_SOURCES = ['linkedin', 'youtube'];
      const TARGETS_DISPLAY_LIMIT = 2;

      const cls = (...values) => values.filter(Boolean).join(' ');

      const normalizeSource = (value) => {
        const parsed = String(value ?? '')
          .replace(/[\[\]\s"']/g, '')
          .trim()
          .toLowerCase();
        return ALLOWED_SOURCES.includes(parsed) ? parsed : null;
      };

      const loadSourcesFromStorage = () => {
        const raw = localStorage.getItem('rivalytics:sources');
        if (!raw) return new Set(ALLOWED_SOURCES);
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            const clean = parsed.map(normalizeSource).filter(Boolean);
            return new Set(clean.length ? clean : ALLOWED_SOURCES);
          }
        } catch {
          // ignore malformed json
        }
        const clean = raw.split(',').map(normalizeSource).filter(Boolean);
        return new Set(clean.length ? clean : ALLOWED_SOURCES);
      };
      const toLinkedInSlug = (value = '') =>
        String(value)
          .normalize('NFKD')
          .replace(/[\u0300-\u036f]/g, '')
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .replace(/--+/g, '-');

      const toDaysParam = (value) => {
        if (value === 'all') return 3650;
        const numeric = typeof value === 'number' ? value : Number(value);
        return Number.isFinite(numeric) && numeric > 0 ? numeric : 30;
      };

      const dedupeByUrl = (items) => {
        const seen = new Set();
        return items.filter((item) => {
          if (!item.url) return true;
          if (seen.has(item.url)) return false;
          seen.add(item.url);
          return true;
        });
      };

      const scoreItem = (item) =>
        (item.metrics?.likes ?? 0) +
        (item.metrics?.views ?? 0) +
        (item.metrics?.comments ?? 0) +
        (item.metrics?.shares ?? 0) +
        (item.metrics?.plays ?? 0);

      function Badge({ kind }) {
        return (
          <span className={cls('px-2 py-0.5 rounded-full text-xs font-semibold', BADGE_CLASSES[kind])}>
            {kind}
          </span>
        );
      }

      function CompanyCard({ company }) {
        if (!company) return null;
        let hostname = null;
        if (company.site) {
          try { hostname = new URL(company.site).hostname; } catch { hostname = company.site; }
        }
        return (
          <div className="card p-4 sm:p-5 flex flex-col sm:flex-row items-start sm:items-center gap-4">
            {company.logo && (
              <img
                src={company.logo}
                alt={company.name ?? 'Logo entreprise'}
                className="w-16 h-16 rounded-2xl object-cover ring-1 ring-white/20 self-center sm:self-auto"
              />
            )}
            <div className="flex-1">
              <div className="flex items-center gap-2">
                <h3 className="text-lg font-semibold">{company.name}</h3>
                <Badge kind="LinkedIn" />
              </div>
              {company.slogan && (
                <div className="text-sm text-gray-200/80 dark:text-gray-300/80">{company.slogan}</div>
              )}
              <div className="text-xs text-gray-300/80 mt-1">
                {company.locality ?? ''}
                {company.country ? `${company.locality ? ', ' : ''}${company.country}` : ''}
                {hostname && (
                  <>
                    <span className="mx-2">·</span>
                    <a
                      className="underline decoration-white/30 hover:decoration-white"
                      href={company.site ?? '#'}
                      target="_blank"
                      rel="noreferrer"
                    >
                      {hostname}
                    </a>
                  </>
                )}
                {Number.isFinite(company.employees) && (
                  <>
                    <span className="mx-2">·</span>
                    {Number(company.employees ?? 0).toLocaleString('fr-FR')} employés
                  </>
                )}
              </div>
            </div>
          </div>
        );
      }

      function MetricBadges({ metrics }) {
        const hasValue = (value) => Number(value ?? 0) > 0;
        if (
          !hasValue(metrics?.likes) &&
          !hasValue(metrics?.views) &&
          !hasValue(metrics?.comments) &&
          !hasValue(metrics?.shares) &&
          !hasValue(metrics?.plays)
        ) {
          return null;
        }
        return (
          <div className="mt-3 flex flex-wrap gap-2 text-sm">
            {hasValue(metrics?.views) && (
              <span className="metric-badge badge-views">👁️ {Number(metrics.views).toLocaleString('fr-FR')}</span>
            )}
            {hasValue(metrics?.likes) && (
              <span className="metric-badge badge-likes">❤ {Number(metrics.likes).toLocaleString('fr-FR')}</span>
            )}
            {hasValue(metrics?.comments) && (
              <span className="metric-badge badge-comments">💬 {Number(metrics.comments).toLocaleString('fr-FR')}</span>
            )}
            {hasValue(metrics?.shares) && (
              <span className="metric-badge badge-shares">🔁 {Number(metrics.shares).toLocaleString('fr-FR')}</span>
            )}
            {hasValue(metrics?.plays) && (
              <span className="metric-badge badge-plays">▶ {Number(metrics.plays).toLocaleString('fr-FR')}</span>
            )}
          </div>
        );
      }

      function ResultItem({ item }) {
        const safeDate = item.date ? new Date(item.date) : null;
        const dateLabel =
          safeDate && !Number.isNaN(safeDate.valueOf())
            ? safeDate.toLocaleDateString('fr-FR')
            : '—';
        return (
          <a
            href={item.url}
            target="_blank"
            rel="noreferrer"
            className="card block p-4 transition glass-hover"
          >
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span className="mr-1">{ICON_BY_TYPE[item.type] ?? '🔗'}</span>
                <Badge kind={item.type} />
              </div>
              <span className="text-xs text-gray-300/80">{dateLabel}</span>
            </div>
            <h3 className="mt-2 font-medium line-clamp-2">{item.title}</h3>
            <MetricBadges metrics={item.metrics ?? {}} />
          </a>
        );
      }

      function SkeletonCard() {
        return (
          <div className="card p-4 animate-pulse">
            <div className="flex justify-between">
              <div className="h-5 w-20 bg-white/20 rounded" />
              <div className="h-4 w-24 bg-white/20 rounded" />
            </div>
            <div className="h-6 w-4/5 bg-white/20 rounded mt-3" />
            <div className="h-4 w-24 bg-white/20 rounded mt-4" />
          </div>
        );
      }

      function AuthModal({ open, mode, form, onFieldChange, onClose, onSubmit, loading, error, onSwitchMode }) {
        if (!open) return null;
        const title = mode === 'login' ? 'Connexion' : 'Créer un compte';
        const actionLabel = mode === 'login' ? 'Se connecter' : 'S’inscrire';
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center px-4 bg-black/60 backdrop-blur-sm">
            <div className="card w-full max-w-md p-6 relative">
              <button
                type="button"
                onClick={onClose}
                className="absolute top-3 right-3 text-white/60 hover:text-white"
                aria-label="Fermer"
              >
                ✕
              </button>
              <h2 className="text-xl font-semibold mb-4 text-white">{title}</h2>
              <form onSubmit={onSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-white/80 mb-1" htmlFor="auth-email">
                    Email
                  </label>
                  <input
                    id="auth-email"
                    type="email"
                    required
                    value={form.email}
                    onChange={(event) => onFieldChange('email', event.target.value)}
                    className="glass-input w-full text-white placeholder:text-white/60"
                    placeholder="ton@email.com"
                    autoComplete="email"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-white/80 mb-1" htmlFor="auth-password">
                    Mot de passe
                  </label>
                  <input
                    id="auth-password"
                    type="password"
                    required
                    minLength={8}
                    value={form.password}
                    onChange={(event) => onFieldChange('password', event.target.value)}
                    className="glass-input w-full text-white placeholder:text-white/60"
                    placeholder="Minimum 8 caractères"
                    autoComplete={mode === 'login' ? 'current-password' : 'new-password'}
                  />
                  <p className="text-xs text-white/50 mt-1">Minimum 8 caractères.</p>
                </div>
                {error && <div className="text-sm text-rose-200">{error}</div>}
                <button type="submit" className="cta w-full flex items-center justify-center" disabled={loading}>
                  {loading ? 'Chargement...' : actionLabel}
                </button>
              </form>
              <div className="mt-4 text-sm text-white/70">
                {mode === 'login' ? (
                  <button
                    type="button"
                    onClick={() => onSwitchMode('register')}
                    className="underline hover:text-white"
                  >
                    Pas encore de compte ? Inscris-toi
                  </button>
                ) : (
                  <button
                    type="button"
                    onClick={() => onSwitchMode('login')}
                    className="underline hover:text-white"
                  >
                    Déjà un compte ? Connecte-toi
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      }

      function TargetsCard({
        user,
        currentName,
        targets,
        loading,
        saving,
        saveState,
        onSave,
        onDelete,
        onSelect,
        onLoginRequired,
      }) {
        const hasName = Boolean(currentName.trim());
        const list = Array.isArray(targets) ? targets : [];
        const [expanded, setExpanded] = useState(false);
        const count = list.length;
        const extraCount = Math.max(0, count - TARGETS_DISPLAY_LIMIT);
        const visibleTargets = expanded ? list : list.slice(0, TARGETS_DISPLAY_LIMIT);

        useEffect(() => {
          if (count <= TARGETS_DISPLAY_LIMIT && expanded) {
            setExpanded(false);
          }
        }, [count, expanded]);

        const toggleExpanded = () => setExpanded((prev) => !prev);

        const handleRun = (name) => {
          const safeName = String(name || '').trim();
          if (!safeName) return;
          onSelect?.(safeName);
        };

        return (
          <div className="card p-4 sm:p-5 mb-6">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div>
                <h2 className="text-lg font-semibold text-white">Mes entreprises</h2>
                <p className="text-sm text-white/70">
                  {user ? `Connecté·e en tant que ${user.email}` : 'Connecte-toi pour sauvegarder tes recherches.'}
                </p>
              </div>
              <div className="flex gap-2 flex-wrap sm:flex-nowrap items-center">
                {user ? (
                  <button
                    type="button"
                    onClick={onSave}
                    disabled={saving || !hasName}
                    className="chip flex items-center justify-center bg-yellow-400/15 border-yellow-200/40 text-yellow-200 hover:brightness-110 disabled:opacity-60 disabled:cursor-not-allowed"
                  >
                    {saving ? '⭐ Sauvegarde...' : `⭐ Sauvegarder${hasName ? ` "${currentName}"` : ''}`}
                  </button>
                ) : (
                  <>
                    <button
                      type="button"
                      onClick={() => onLoginRequired('login')}
                      className="chip flex items-center justify-center"
                    >
                      Se connecter
                    </button>
                    <button
                      type="button"
                      onClick={() => onLoginRequired('register')}
                      className="chip flex items-center justify-center"
                    >
                      Créer un compte
                    </button>
                  </>
                )}
              </div>
            </div>
            {user && saveState?.message && (
              <div
                className={cls(
                  'mt-3 text-sm',
                  saveState.status === 'success' ? 'text-emerald-200' : 'text-rose-200'
                )}
              >
                {saveState.message}
              </div>
            )}
            {user && (
              <div className="mt-4">
                {loading ? (
                  <div className="text-sm text-white/70">Chargement...</div>
                ) : list.length ? (
                  <ul className="space-y-2">
                    {visibleTargets.map((target) => {
                      const addedAt = target.created_at ? new Date(target.created_at) : null;
                      const addedLabel =
                        addedAt && !Number.isNaN(addedAt.valueOf())
                          ? addedAt.toLocaleDateString('fr-FR', {
                              day: 'numeric',
                              month: 'short',
                              year: 'numeric',
                            })
                          : '—';
                      return (
                        <li key={target.id} className="glass px-3 py-2 rounded-lg">
                          <div className="flex items-start justify-between gap-3">
                            <div className="flex flex-col flex-1 min-w-0">
                              <span className="text-sm font-medium text-white truncate max-w-[220px] sm:max-w-[260px]">
                                {target.name}
                              </span>
                              <span className="text-xs text-white/50">Ajouté le {addedLabel}</span>
                              <div className="flex flex-wrap gap-2 mt-2">
                                <button
                                  type="button"
                                  onClick={() => handleRun(target.name)}
                                  className="chip flex items-center justify-center text-xs sm:text-sm bg-indigo-400/15 border-indigo-200/40 text-indigo-100 hover:brightness-110"
                                  aria-label={`Relancer l’analyse pour ${target.name}`}
                                >
                                  🚀 Relancer
                                </button>
                              </div>
                            </div>
                            <button
                              type="button"
                              onClick={() => onDelete(target.id)}
                              className="text-xs text-white/70 hover:text-white"
                              aria-label={`Supprimer ${target.name}`}
                            >
                              ✖
                            </button>
                          </div>
                        </li>
                      );
                    })}
                  </ul>
                ) : (
                  <div className="text-sm text-white/70">
                    Utilise “⭐ Sauvegarder” pour conserver une entreprise à surveiller.
                  </div>
                )}
                {list.length > TARGETS_DISPLAY_LIMIT && (
                  <div className="mt-3">
                    <button
                      type="button"
                      onClick={toggleExpanded}
                      className="text-xs text-white/70 underline decoration-white/40 hover:text-white"
                    >
                      {expanded
                        ? 'Réduire la liste'
                        : `Afficher ${extraCount} entreprise${extraCount > 1 ? 's' : ''} supplémentaires`}
                    </button>
                  </div>
                )}
              </div>
            )}
            {!user && (
              <div className="mt-4 text-sm text-white/70">
                Enregistre tes entreprises favorites en créant un compte gratuit.
              </div>
            )}
            {user && !hasName && (
              <div className="mt-3 text-xs text-white/60">
                Recherche une entreprise pour activer le bouton “⭐ Sauvegarder”.
              </div>
            )}
          </div>
        );
      }

      function StatCard({ title, value, subtitle, icon }) {
        return (
          <div className="stat-card p-4 sm:p-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-2xl">{icon}</span>
            </div>
            <div className="text-2xl sm:text-3xl font-extrabold drop-shadow">
              {typeof value === 'number' ? value.toLocaleString('fr-FR') : value}
            </div>
            <div className="text-sm text-gray-200/90 mt-1">{title}</div>
            {subtitle && <div className="text-xs text-gray-300/80 mt-2">{subtitle}</div>}
          </div>
        );
      }

      function ProgressBar({ value, max }) {
        const ratio = Math.round(((value || 0) / Math.max(max || 1, 1)) * 100) || 0;
        return (
          <div className="progress-outer">
            <div className="progress-inner" style={{ width: `${ratio}%` }} />
          </div>
        );
      }

      function StatusPill({ source, status }) {
        const classes = {
          pending: 'border-indigo-400/40 text-indigo-200',
          done: 'border-emerald-400/40 text-emerald-200',
          empty: 'border-white/20 text-white/70',
          error: 'border-rose-400/40 text-rose-300',
          idle: 'border-white/20 text-white/70',
        };
        return (
          <span className={cls('px-3 py-1 rounded-full text-[11px] sm:text-xs border inline-flex items-center gap-2 glass', classes[status] ?? classes.idle)}>
            <span>{SOURCE_ICON[source] ?? '•'}</span>
            {status === 'pending' ? <span className="spinner" /> : <span className="text-xs">·</span>}
            <span className="font-medium">{source.toUpperCase()}</span>
          </span>
        );
      }

      function EngagementChart({ data, dark }) {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
          if (!canvasRef.current) return undefined;
          if (chartRef.current) chartRef.current.destroy();
          const ctx = canvasRef.current.getContext('2d');
          if (!ctx) return undefined;

          const labels = TYPE_ORDER;
          const values = labels.map((key) => data[key] || 0);

          chartRef.current = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Engagement total',
                data: values,
                backgroundColor: [
                  'rgba(120,115,245,.45)',
                  'rgba(236,72,153,.40)',
                ],
                borderColor: [
                  'rgba(120,115,245,1)',
                  'rgba(236,72,153,1)',
                ],
                borderWidth: 1.2,
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (ctx) => `${ctx.parsed.y.toLocaleString('fr-FR')} interactions`,
                  },
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: dark ? 'rgba(255,255,255,.14)' : 'rgba(255,255,255,.22)' },
                  ticks: { color: dark ? '#cbd5e1' : '#e5e7eb' },
                },
                x: {
                  grid: { display: false },
                  ticks: { color: dark ? '#cbd5e1' : '#e5e7eb' },
                },
              },
            },
          });

          return () => chartRef.current && chartRef.current.destroy();
        }, [data, dark]);

        return <canvas ref={canvasRef} />;
      }

      function TimelineChart({ data, dark }) {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
          if (!canvasRef.current) return undefined;
          if (chartRef.current) chartRef.current.destroy();
          const ctx = canvasRef.current.getContext('2d');
          if (!ctx) return undefined;

          const grouped = new Map();
          data.forEach((item) => {
            if (!item.date) return;
            grouped.set(item.date, (grouped.get(item.date) ?? 0) + 1);
          });
          const labelsISO = Array.from(grouped.keys()).sort();
          const values = labelsISO.map((key) => grouped.get(key) ?? 0);

          chartRef.current = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labelsISO.map((value) =>
                new Date(value).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })
              ),
              datasets: [{
                label: 'Publications',
                data: values,
                fill: true,
                backgroundColor: 'rgba(120,115,245,.18)',
                borderColor: 'rgba(120,115,245,1)',
                borderWidth: 1.5,
                tension: 0.35,
                pointRadius: 2,
                pointBackgroundColor: 'rgba(255,255,255,.9)',
              }],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: { color: dark ? 'rgba(255,255,255,.14)' : 'rgba(255,255,255,.22)' },
                  ticks: { color: dark ? '#cbd5e1' : '#e5e7eb', stepSize: 1 },
                },
                x: {
                  grid: { display: false },
                  ticks: { color: dark ? '#cbd5e1' : '#e5e7eb' },
                },
              },
            },
          });

          return () => chartRef.current && chartRef.current.destroy();
        }, [data, dark]);

        return <canvas ref={canvasRef} />;
      }

      function App() {
        const dark = true;
        useEffect(() => {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        }, []);

        const [tab, setTab] = useState('search');
        const [name, setName] = useState(() => localStorage.getItem('rivalytics:lastName') || '');
        const [days, setDays] = useState(() => {
          const stored = localStorage.getItem('rivalytics:days');
          if (stored === 'all') return 'all';
          const parsed = Number(stored);
          return Number.isFinite(parsed) && parsed > 0 ? parsed : 30;
        });

        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const [note, setNote] = useState(null);
        const [allResults, setAllResults] = useState([]);
        const [company, setCompany] = useState(null);

        const [types, setTypes] = useState(() => new Set(ALL_TYPES));
        const [sources, setSources] = useState(loadSourcesFromStorage);
        const initialStatuses = { linkedin: 'idle', youtube: 'idle' };
        const [statuses, setStatuses] = useState(initialStatuses);

        const [user, setUser] = useState(null);
        const [authModal, setAuthModal] = useState({ open: false, mode: 'login' });
        const [authForm, setAuthForm] = useState({ email: '', password: '' });
        const [authLoading, setAuthLoading] = useState(false);
        const [authError, setAuthError] = useState(null);
        const [targets, setTargets] = useState([]);
        const [targetsLoading, setTargetsLoading] = useState(false);
        const [savingTarget, setSavingTarget] = useState(false);
        const [saveState, setSaveState] = useState(null);

        const abortRef = useRef(null);
        const inputRef = useRef(null);

        useEffect(() => { inputRef.current?.focus(); }, []);
        useEffect(() => { localStorage.setItem('rivalytics:lastName', name); }, [name]);
        useEffect(() => { localStorage.setItem('rivalytics:days', String(days)); }, [days]);
        useEffect(() => { localStorage.setItem('rivalytics:sources', JSON.stringify(Array.from(sources))); }, [sources]);

        const fetchCurrentUser = useCallback(async () => {
          try {
            const res = await fetch('/auth/me', { credentials: 'include' });
            if (res.status === 401) {
              setUser(null);
              setTargets([]);
              return;
            }
            if (!res.ok) return;
            const data = await res.json();
            setUser(data.user ?? null);
          } catch (err) {
            console.error('fetchCurrentUser failed', err);
          }
        }, [setUser, setTargets]);
        useEffect(() => { fetchCurrentUser(); }, [fetchCurrentUser]);

        const loadTargets = useCallback(async () => {
          setTargetsLoading(true);
          try {
            const res = await fetch('/targets', { credentials: 'include' });
            if (res.status === 401) {
              setUser(null);
              setTargets([]);
              return;
            }
            if (!res.ok) return;
            const data = await res.json();
            setTargets(Array.isArray(data.targets) ? data.targets : []);
          } catch (err) {
            console.error('loadTargets failed', err);
          } finally {
            setTargetsLoading(false);
          }
        }, [setUser, setTargets]);
        useEffect(() => {
          if (!user) {
            setTargets([]);
            setTargetsLoading(false);
            return;
          }
          loadTargets();
        }, [user, loadTargets]);

        useEffect(() => { setSaveState(null); }, [name]);

        const openAuthModal = (mode = 'login') => {
          setAuthForm({ email: '', password: '' });
          setAuthError(null);
          setAuthModal({ open: true, mode });
        };

        const switchAuthMode = (mode) => {
          setAuthError(null);
          setAuthModal({ open: true, mode });
        };

        const closeAuthModal = () => {
          setAuthModal((prev) => ({ ...prev, open: false }));
          setAuthError(null);
        };

        const handleAuthFieldChange = (field, value) => {
          setAuthForm((prev) => ({ ...prev, [field]: value }));
        };

        const handleAuthSubmit = async (event) => {
          event.preventDefault();
          const payload = {
            email: authForm.email.trim().toLowerCase(),
            password: authForm.password,
          };
          if (!payload.email || !payload.password) {
            setAuthError('Renseigne un email et un mot de passe.');
            return;
          }
          setAuthLoading(true);
          setAuthError(null);
          const endpoint = authModal.mode === 'login' ? '/auth/login' : '/auth/register';
          try {
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload),
            });
            if (!res.ok) {
              let message = 'Action impossible pour le moment.';
              try {
                const data = await res.json();
                const map = {
                  invalid_email: 'Email invalide.',
                  invalid_password: 'Mot de passe trop court.',
                  email_exists: 'Cet email est déjà utilisé.',
                  invalid_credentials: 'Email ou mot de passe incorrect.',
                  registration_failed: 'Inscription impossible pour le moment.',
                  login_failed: 'Connexion impossible pour le moment.',
                  database_unavailable: 'Base de données indisponible.',
                  jwt_not_configured: 'Serveur non configuré pour l’authentification.',
                };
                message = map[data?.error] ?? message;
              } catch {
                // ignore
              }
              setAuthError(message);
              return;
            }
            const data = await res.json();
            setUser(data.user ?? null);
            setAuthModal({ open: false, mode: 'login' });
            setAuthForm({ email: '', password: '' });
            setAuthError(null);
            await loadTargets();
          } catch (err) {
            console.error('auth submit failed', err);
            setAuthError('Erreur réseau, réessaie dans un instant.');
          } finally {
            setAuthLoading(false);
          }
        };

        const handleLogout = async () => {
          try {
            await fetch('/auth/logout', {
              method: 'POST',
              credentials: 'include',
            });
          } catch (err) {
            console.error('logout failed', err);
          } finally {
            setUser(null);
            setTargets([]);
            setSaveState(null);
            setAuthModal({ open: false, mode: 'login' });
          }
        };

        const handleSaveTarget = async () => {
          if (!user) {
            openAuthModal('login');
            return;
          }
          const trimmed = name.trim();
          if (!trimmed) {
            setSaveState({ status: 'error', message: 'Renseigne un nom à sauvegarder.' });
            return;
          }
          setSavingTarget(true);
          setSaveState(null);
          try {
            const res = await fetch('/targets', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ name: trimmed }),
            });
            if (res.status === 401) {
              setUser(null);
              setTargets([]);
              setSaveState({ status: 'error', message: 'Session expirée, reconnecte-toi.' });
              openAuthModal('login');
              return;
            }
            if (res.status === 409) {
              setSaveState({ status: 'error', message: 'Cette entreprise est déjà dans ta liste.' });
              return;
            }
            if (!res.ok) {
              throw new Error('request_failed');
            }
            const data = await res.json();
            if (data?.target) {
              setTargets((prev) => {
                const without = prev.filter((item) => item.id !== data.target.id);
                return [data.target, ...without];
              });
            }
            setSaveState({ status: 'success', message: 'Entreprise sauvegardée !' });
          } catch (err) {
            console.error('save target failed', err);
            setSaveState({ status: 'error', message: 'Impossible de sauvegarder pour le moment.' });
          } finally {
            setSavingTarget(false);
          }
        };

        const handleDeleteTarget = async (targetId) => {
          try {
            const res = await fetch(`/targets/${targetId}`, {
              method: 'DELETE',
              credentials: 'include',
            });
            if (res.status === 401) {
              setUser(null);
              setTargets([]);
              setSaveState({ status: 'error', message: 'Session expirée, reconnecte-toi.' });
              openAuthModal('login');
              return;
            }
            if (res.status !== 204 && res.status !== 200 && res.status !== 404) {
              throw new Error('request_failed');
            }
            setTargets((prev) => prev.filter((item) => item.id !== targetId));
          } catch (err) {
            console.error('delete target failed', err);
            setSaveState({ status: 'error', message: 'Suppression impossible pour le moment.' });
          }
        };

        const toggleType = (type) => {
          setTypes((prev) => {
            const next = new Set(prev);
            if (next.has(type)) next.delete(type);
            else next.add(type);
            if (next.size === 0) next.add(TYPE_ORDER[0]);
            return next;
          });
        };

        const toggleSource = (source) => {
          setSources((prev) => {
            const next = new Set(prev);
            if (next.has(source)) next.delete(source);
            else next.add(source);
            if (next.size === 0 && ALLOWED_SOURCES.length > 0) {
              next.add(ALLOWED_SOURCES[0]);
            }
            return next;
          });
        };

        const applyPreset = (label) => {
          const preset = SOURCE_PRESETS[label];
          if (preset) setSources(new Set(preset));
        };

        const updateStatus = (source, status) => {
          setStatuses((prev) => ({ ...prev, [source]: status }));
        };

        const pushResults = (items = []) => {
          if (!Array.isArray(items)) return;
          setAllResults((prev) => dedupeByUrl([...prev, ...items]));
        };

        const runSearch = async (overrideName) => {
          const raw = (overrideName ?? name).trim();
          if (!raw) return;

          abortRef.current?.abort();
          const controller = new AbortController();
          abortRef.current = controller;

          setLoading(true);
          setError(null);
          setNote(null);
          setSaveState(null);
          setAllResults([]);
          setCompany(null);
          setStatuses({
            linkedin: sources.has('linkedin') ? 'pending' : 'idle',
            youtube: sources.has('youtube') ? 'pending' : 'idle',
          });

          const lower = raw.toLowerCase();
          const daysParam = toDaysParam(days);
          const signal = controller.signal;
          const pending = [];

          const wrap = (source, request) =>
            request
              .then((res) => {
                if (!res.ok) throw new Error('http_error');
                return res.json();
              })
              .then((json) => {
                if (json.company) setCompany(json.company);
                if (Array.isArray(json.items)) pushResults(json.items);
                if (json.note) setNote(json.note);
                updateStatus(source, Array.isArray(json.items) && json.items.length > 0 ? 'done' : 'empty');
              })
              .catch((err) => {
                if (err?.name === 'AbortError') return;
                updateStatus(source, 'error');
              });

          if (sources.has('linkedin')) {
            const url = new URL('/api/linkedin', window.location.origin);
            url.searchParams.set('slug', toLinkedInSlug(raw));
            url.searchParams.set('days', String(daysParam));
            url.searchParams.set('limit', '20');
            pending.push(wrap('linkedin', fetch(url, { signal })));
          }
          if (sources.has('youtube')) {
            const url = new URL('/api/youtube', window.location.origin);
            url.searchParams.set('q', raw);
            url.searchParams.set('days', String(daysParam));
            url.searchParams.set('limit', '12');
            pending.push(wrap('youtube', fetch(url, { signal })));
          }

          Promise.allSettled(pending).then(() => {
            setLoading(false);
            abortRef.current = null;
            setAllResults((prev) => {
              if (prev.length === 0) setError('Aucune donnée récente trouvée.');
              return prev;
            });
          });
        };

        const handleRunTarget = (targetName) => {
          const trimmed = String(targetName || '').trim();
          if (!trimmed) return;
          setName(trimmed);
          setTab('search');
          inputRef.current?.focus();
          runSearch(trimmed);
        };

        const cancelSearch = () => {
          abortRef.current?.abort();
          abortRef.current = null;
          setLoading(false);
          setStatuses((prev) => {
            const next = { ...prev };
            Object.keys(next).forEach((key) => {
              if (next[key] === 'pending') next[key] = 'error';
            });
            return next;
          });
        };

        const filtered = useMemo(
          () => allResults.filter((item) => types.has(item.type)),
          [allResults, types]
        );

        const grouped = useMemo(() => {
          const map = {};
          TYPE_ORDER.forEach((type) => { map[type] = []; });
          filtered.forEach((item) => {
            if (!map[item.type]) map[item.type] = [];
            map[item.type].push(item);
          });
          Object.keys(map).forEach((key) => {
            map[key] = map[key].sort((a, b) => {
              if (!a.date) return 1;
              if (!b.date) return -1;
              return a.date < b.date ? 1 : -1;
            });
          });
          return map;
        }, [filtered]);

        const stats = useMemo(() => {
          const totalEngagement = filtered.reduce((acc, item) => acc + scoreItem(item), 0);
          const engagementByType = {};
          TYPE_ORDER.forEach((type) => {
            engagementByType[type] = (grouped[type] ?? []).reduce((acc, item) => acc + scoreItem(item), 0);
          });
          const avgEngagement = filtered.length ? Math.round(totalEngagement / filtered.length) : 0;
          const topContent = [...filtered].sort((a, b) => scoreItem(b) - scoreItem(a))[0];
          const daysSet = new Set(filtered.map((item) => item.date).filter(Boolean));
          const pubFreq = daysSet.size ? (filtered.length / daysSet.size).toFixed(1) : '0';
          return { total: filtered.length, totalEngagement, avgEngagement, engagementByType, topContent, pubFreq, uniqueDays: daysSet.size };
        }, [filtered, grouped]);

        const activeSources = useMemo(() => Array.from(sources), [sources]);
        const totalJobs = activeSources.length;
        const doneCount = activeSources.filter((src) => ['done','empty','error'].includes(statuses[src])).length;
        const anyPending = activeSources.some((src) => statuses[src] === 'pending');

        const trimmedName = name.trim();

        return (
          <div className="min-h-screen min-h-[100dvh] relative z-10 flex flex-col overflow-hidden">
            <div className="bg-noise" />
            <div className="blob blob1" />
            <div className="blob blob2" />
            <div className="blob blob3" />

            <header className="px-3 sm:px-6">
              <div className="glassbar">
                <div className="max-w-7xl mx-auto flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                  <div className="relative">
                    <h1 className="text-2xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-indigo-300 via-fuchsia-300 to-emerald-300 drop-shadow">
                      Rivalytics
                    </h1>
                    <p className="text-xs text-white/70 mt-0.5">Analyse concurrentielle multi-plateformes</p>
                  </div>
                  <div className="flex items-center gap-2 flex-wrap sm:flex-nowrap justify-end">
                    <button onClick={() => setTab('dashboard')} className={cls('chip flex items-center justify-center', tab === 'dashboard' && 'active')}>📊 Dashboard</button>
                    <button onClick={() => setTab('search')} className={cls('chip flex items-center justify-center', tab === 'search' && 'active')}>🔍 Recherche</button>
                    {user ? (
                      <div className="chip flex items-center gap-2 max-w-[220px]">
                        <span className="truncate">👤 {user.email}</span>
                        <button
                          type="button"
                          onClick={handleLogout}
                          className="text-xs underline decoration-white/40 hover:decoration-white text-white/80 hover:text-white"
                        >
                          Déconnexion
                        </button>
                      </div>
                    ) : (
                      <>
                        <button
                          type="button"
                          onClick={() => openAuthModal('login')}
                          className="chip flex items-center justify-center"
                        >
                          Connexion
                        </button>
                        <button
                          type="button"
                          onClick={() => openAuthModal('register')}
                          className="chip flex items-center justify-center"
                        >
                          Inscription
                        </button>
                      </>
                    )}
                  </div>
                </div>
              </div>
            </header>

            <main className="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 py-6">
              <form
                onSubmit={(event) => { event.preventDefault(); runSearch(); }}
                className="flex flex-col sm:flex-row gap-3 mb-6 w-full"
              >
                <input
                  ref={inputRef}
                  value={name}
                  onChange={(event) => setName(event.target.value)}
                  placeholder="Nom du concurrent (ex: Accenture, Dev First...)"
                  className="glass-input flex-1 w-full text-white placeholder:text-white/60"
                />
                <div className="flex gap-2 flex-wrap sm:flex-nowrap">
                  {DAY_PRESETS.map((preset) => (
                    <button
                      type="button"
                      key={preset.label}
                      onClick={() => setDays(preset.value)}
                      className={cls('chip text-sm w-full sm:w-auto flex items-center justify-center', String(days) === String(preset.value) && 'active')}
                    >
                      {preset.label}
                    </button>
                  ))}
                </div>
                <div className="flex items-center gap-2 flex-wrap sm:flex-nowrap">
                  <button type="submit" disabled={loading || !name.trim()} className="cta w-full sm:w-auto flex items-center justify-center">
                    {loading ? '⏳ Analyse...' : '🚀 Analyser'}
                  </button>
                  {loading && (
                    <button
                      type="button"
                      onClick={cancelSearch}
                      className="chip text-rose-200 border-rose-300/30 hover:brightness-110 w-full sm:w-auto flex items-center justify-center"
                      title="Annuler la recherche en cours"
                    >
                      ✖ Annuler
                    </button>
                  )}
                </div>
              </form>

              <TargetsCard
                user={user}
                currentName={trimmedName}
                targets={targets}
                loading={targetsLoading}
                saving={savingTarget}
                saveState={saveState}
                onSave={handleSaveTarget}
                onDelete={handleDeleteTarget}
                onSelect={handleRunTarget}
                onLoginRequired={openAuthModal}
              />

              <div className="card p-4 sm:p-5 mb-6">
                <div className="flex items-center gap-3 flex-wrap">
                  <span className="text-sm font-medium text-white/90">Sources :</span>
                  {ALLOWED_SOURCES.map((source) => (
                    <button
                      key={source}
                      onClick={() => toggleSource(source)}
                      className={cls('chip text-sm w-full sm:w-auto flex items-center justify-center', sources.has(source) && 'active')}
                    >
                      {SOURCE_ICON[source]} {source.toUpperCase()}
                    </button>
                  ))}
                  <div className="ml-auto flex gap-2 flex-wrap sm:flex-nowrap">
                    {Object.keys(SOURCE_PRESETS).map((label) => (
                      <button key={label} onClick={() => applyPreset(label)} className="chip text-sm w-full sm:w-auto flex items-center justify-center">
                        {label}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {note && (
                <div className="card p-4 sm:p-5 mb-6 border-indigo-400/40 text-indigo-100 text-sm">
                  {note}
                </div>
              )}

              {error && (
                <div className="card p-4 sm:p-5 mb-6 border-amber-400/40">
                  <span className="text-amber-200">⚠️ {error}</span>
                </div>
              )}

              {tab === 'search' && (
                <div className="space-y-6">
                  {company && (
                    <div>
                      <h2 className="text-lg font-semibold mb-3">Entreprise analysée</h2>
                      <CompanyCard company={company} />
                    </div>
                  )}

                  {(loading || anyPending) && (
                    <div className="card p-4 sm:p-5 animate-slide-up">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <span className="spinner text-indigo-300" />
                          <span className="font-medium">Collecte en cours…</span>
                        </div>
                        <div className="text-sm text-white/70">{doneCount}/{Math.max(totalJobs, 1)}</div>
                      </div>
                      <ProgressBar value={doneCount} max={Math.max(totalJobs, 1)} />
                      <div className="mt-3 flex flex-wrap gap-2">
                        {activeSources.map((source) => (
                          <StatusPill key={source} source={source} status={statuses[source]} />
                        ))}
                      </div>
                    </div>
                  )}

                  {!loading && (
                    <div className="space-y-2">
                      <div className="flex items-baseline gap-2 flex-wrap">
                        <span className="text-3xl font-semibold tracking-tight drop-shadow">
                          {filtered.length}
                        </span>
                        <span className="text-base text-white/80">
                          contenus publiés {days === 'all' ? 'au total' : `sur les ${days} derniers jours`}
                        </span>
                      </div>

                      {/* Types disponibles */}
                      <div className="flex items-center gap-2 flex-wrap mt-1">
                        {TYPE_ORDER.filter((type) => (grouped[type] ?? []).length).map((type) => (
                          <div
                            key={type}
                            className={cls(
                              'chip inline-flex items-center gap-2',
                              types.has(type) && 'active'
                            )}
                            title={`${type} • ${(grouped[type] ?? []).length}`}
                          >
                            <span className="text-base leading-none">{ICON_BY_TYPE[type]}</span>
                            <span className={cls('px-2 py-0.5 rounded-full text-xs font-semibold', BADGE_CLASSES[type])}>
                              {type}
                            </span>
                            <span className="text-xs rounded-md px-1.5 py-0.5 bg-white/10 text-white/90">
                              {(grouped[type] ?? []).length}
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {loading && filtered.length === 0 && (
                    <div role="status" aria-live="polite" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Array.from({ length: 6 }).map((_, index) => <SkeletonCard key={index} />)}
                    </div>
                  )}

                  {TYPE_ORDER.filter((type) => (grouped[type] ?? []).length).map((type) => (
                    <div key={type} className="space-y-3">
                      <div className="flex items-center gap-2">
                        <span className="text-xl font-semibold">{ICON_BY_TYPE[type]}</span>
                        <h2 className="text-xl font-semibold">{type}</h2>
                        <span className="text-sm text-white/70">({(grouped[type] ?? []).length})</span>
                      </div>
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {(grouped[type] ?? []).map((item) => (
                          <ResultItem key={item.id} item={item} />
                        ))}
                      </div>
                    </div>
                  ))}

                  {loading && (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Array.from({ length: 6 }).map((_, index) => <SkeletonCard key={index} />)}
                    </div>
                  )}

                  {!loading && filtered.length === 0 && (
                    <div className="text-white/80 text-sm">Aucun résultat pour ces filtres.</div>
                  )}
                </div>
              )}

              {tab === 'dashboard' && (
                <div className="space-y-6 animate-slide-up">
                  {company && (
                    <div>
                      <h2 className="text-lg font-semibold mb-3">Entreprise analysée</h2>
                      <CompanyCard company={company} />
                    </div>
                  )}

                  {(loading || anyPending) && (
                    <div className="card p-4 sm:p-5 animate-slide-up">
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                          <span className="spinner text-indigo-300" />
                          <span className="font-medium">Collecte en cours…</span>
                        </div>
                        <div className="text-sm text-white/70">{doneCount}/{Math.max(totalJobs, 1)}</div>
                      </div>
                      <ProgressBar value={doneCount} max={Math.max(totalJobs, 1)} />
                      <div className="mt-3 flex flex-wrap gap-2">
                        {activeSources.map((source) => (
                          <StatusPill key={source} source={source} status={statuses[source]} />
                        ))}
                      </div>
                    </div>
                  )}

                  {filtered.length > 0 ? (
                    <>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard title="Publications totales" value={stats.total} subtitle={`${stats.uniqueDays} jours actifs`} icon="📈" />
                        <StatCard title="Engagement total" value={stats.totalEngagement} subtitle="Likes, vues, comments, shares" icon="💬" />
                        <StatCard title="Engagement moyen" value={stats.avgEngagement} subtitle="Par publication" icon="⭐" />
                        <StatCard title="Fréquence" value={stats.pubFreq} subtitle="Publications/jour" icon="📅" />
                      </div>

                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="card p-4 sm:p-6">
                          <h3 className="font-semibold mb-4">📊 Engagement par plateforme</h3>
                          <div style={{ height: '250px' }}><EngagementChart data={stats.engagementByType} dark={dark} /></div>
                        </div>
                        <div className="card p-4 sm:p-6">
                          <h3 className="font-semibold mb-4">📈 Timeline des publications</h3>
                          <div style={{ height: '250px' }}><TimelineChart data={filtered} dark={dark} /></div>
                        </div>
                      </div>

                      {stats.topContent && (
                        <div className="card p-4 sm:p-6">
                          <h3 className="font-semibold mb-4">🏆 Contenu le plus performant</h3>
                          <div className="flex items-start gap-4">
                            <div className="text-3xl">{ICON_BY_TYPE[stats.topContent.type]}</div>
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-2">
                                <Badge kind={stats.topContent.type} />
                                <span className="text-sm text-white/70">
                                  {stats.topContent.date ? new Date(stats.topContent.date).toLocaleDateString('fr-FR') : '—'}
                                </span>
                              </div>
                              <h4 className="font-medium mb-2">{stats.topContent.title}</h4>
                              <MetricBadges metrics={stats.topContent.metrics ?? {}} />
                              <a
                                href={stats.topContent.url}
                                target="_blank"
                                rel="noreferrer"
                                className="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-fuchsia-600 text-white hover:brightness-110 mt-2 border border-white/20"
                              >
                                Ouvrir le post ↗
                              </a>
                            </div>
                          </div>
                        </div>
                      )}

                      <section className="mt-6">
                        <h3 className="text-lg font-semibold mb-3">Tous les contenus ({filtered.length})</h3>

                        {TYPE_ORDER.filter((type) => (grouped[type] ?? []).length).map((type) => (
                          <div key={type} className="space-y-3 mb-5">
                            <div className="flex items-center gap-2">
                              <span className="text-xl font-semibold">{ICON_BY_TYPE[type]}</span>
                              <h4 className="text-lg font-semibold">{type}</h4>
                              <span className="text-sm text-white/70">({(grouped[type] ?? []).length})</span>
                              <div className="ml-2">
                                <div
                                  className={cls('chip inline-flex items-center gap-2', types.has(type) && 'active')}
                                  title={`${type} • ${(grouped[type] ?? []).length}`}
                                >
                                  <span className="text-base leading-none">{ICON_BY_TYPE[type]}</span>
                                  <span className={cls('px-2 py-0.5 rounded-full text-xs font-semibold', BADGE_CLASSES[type])}>
                                    {type}
                                  </span>
                                  <span className="text-xs rounded-md px-1.5 py-0.5 bg-white/10 text-white/90">
                                    {(grouped[type] ?? []).length}
                                  </span>
                                </div>
                              </div>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                              {(grouped[type] ?? []).map((item) => (
                                <ResultItem key={item.id} item={item} />
                              ))}
                            </div>
                          </div>
                        ))}
                      </section>
                    </>
                  ) : (
                    !loading && <div className="text-sm text-white/80">Lance une recherche pour afficher le dashboard.</div>
                  )}

                  {loading && (
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Array.from({ length: 6 }).map((_, index) => <SkeletonCard key={index} />)}
                    </div>
                  )}
                </div>
              )}
            </main>

            <footer className="mt-16 border-t border-white/10">
              <div className="max-w-6xl mx-auto px-4 py-8 flex flex-col gap-4 text-xs text-white/70 text-center sm:flex-row sm:items-center sm:justify-between sm:text-left">
                <p className="leading-relaxed">
                  Données <b>réelles</b> via YouTube + LinkedIn (public “guest”). Intégrations Instagram & TikTok disponibles sur demande (API payante).
                </p>
                <nav className="flex items-center justify-center gap-5 font-medium">
                  <a href="/privacy.html" className="transition-colors hover:text-white">Politique de confidentialité</a>
                  <span className="hidden sm:block text-white/30">•</span>
                  <a href="/tos.html" className="transition-colors hover:text-white">Conditions d'utilisation</a>
                </nav>
              </div>
            </footer>

            <AuthModal
              open={authModal.open}
              mode={authModal.mode}
              form={authForm}
              onFieldChange={handleAuthFieldChange}
              onClose={closeAuthModal}
              onSubmit={handleAuthSubmit}
              loading={authLoading}
              error={authError}
              onSwitchMode={switchAuthMode}
            />
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
