<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rivalytics</title>
  <link rel="icon" href="/favicon-v2.ico">
  <meta name="theme-color" content="#111827">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    .card{border-radius:1.25rem;border:1px solid rgba(0,0,0,.08);background:rgba(0,0,0,.02)}
    .card:hover{background:rgba(0,0,0,.05)}
    .dark .card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04)}
    .dark .card:hover{background:rgba(255,255,255,.07)}
    .chip{padding:.5rem .875rem;border-radius:999px;border:1px solid rgba(0,0,0,.12)}
    .chip.active{background:rgba(99,102,241,.12);border-color:rgba(99,102,241,.35)}
    .group-label{font-size:.75rem;letter-spacing:.02em;color:#64748b}
  </style>
</head>
<body class="bg-white text-gray-900 dark:bg-gray-950 dark:text-gray-100">
  <div id="root" class="min-h-screen flex items-start justify-center p-6"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const TYPE_ORDER = ["LinkedIn","Instagram","TikTok","YouTube","Blog"];
    const BADGE = {
      LinkedIn: "bg-blue-100 text-blue-700 dark:bg-blue-600/20 dark:text-blue-300",
      Instagram: "bg-pink-100 text-pink-700 dark:bg-pink-600/20 dark:text-pink-300",
      TikTok:    "bg-purple-100 text-purple-700 dark:bg-purple-600/20 dark:text-purple-300",
      YouTube:   "bg-red-100 text-red-700 dark:bg-red-600/20 dark:text-red-300",
      Blog:      "bg-emerald-100 text-emerald-700 dark:bg-emerald-600/20 dark:text-emerald-300",
    };
    const ICON = { LinkedIn:"🔷", Instagram:"📸", TikTok:"🎵", YouTube:"▶️", Blog:"📝" };
    const cls = (...a)=>a.filter(Boolean).join(" ");

    const ALL_TYPES = ["LinkedIn","Instagram","TikTok","YouTube","Blog"];
    const SOURCE_TO_TYPE = { linkedin:"LinkedIn", rss:"Blog", youtube:"YouTube", instagram:"Instagram", tiktok:"TikTok" };

    const PRESETS = {
      Gratuit: new Set(["rss","youtube","linkedin"]),
      Réseaux: new Set(["linkedin","instagram","tiktok","youtube"]),
      Tout:    new Set(["rss","linkedin","instagram","tiktok","youtube"]),
    };

    const DAY_PRESETS = [
      {label:"7j",  value:7},
      {label:"14j", value:14},
      {label:"30j", value:30},
      {label:"Depuis le début", value:"all"},
    ];

    const slugifyNameToHandle = (name='') =>
      String(name)
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9._]+/g, '')
        .toLowerCase();

    const toLinkedInSlug = (s='') =>
      String(s)
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .replace(/--+/g, '-');

    function Badge({kind}){
      return <span className={cls("px-2 py-0.5 rounded-full text-xs font-medium", BADGE[kind] || "bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300")}>{kind}</span>;
    }

    function CompanyCard({company}){
      if(!company) return null;
      return (
        <div className="card p-4 flex items-center gap-4">
          {company.logo && <img src={company.logo} alt={company.name} className="w-16 h-16 rounded-xl object-cover" />}
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <h3 className="text-lg font-semibold">{company.name}</h3>
              <Badge kind="LinkedIn"/>
            </div>
            {company.slogan && <div className="text-sm text-gray-600 dark:text-gray-400">{company.slogan}</div>}
            <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
              {(company.locality||'')}{company.country ? (company.locality?', ':'')+company.country : ''}
              {company.site && <>
                <span className="mx-2">·</span>
                <a className="underline" href={company.site} target="_blank" rel="noreferrer">{company.site}</a>
              </>}
              {Number.isFinite(company.employees) && <><span className="mx-2">·</span>{company.employees} employés</>}
            </div>
          </div>
        </div>
      );
    }

    function ResultItem({item}){
      const date = new Date(item.date).toLocaleDateString("fr-FR");
      const m = item.metrics || {};
      const metric =
        m.likes ?? m.views ?? m.plays ?? m.comments ?? m.shares ?? "—";
      const label =
        m.likes!==undefined ? "likes" :
        m.views!==undefined || m.plays!==undefined ? "vues" :
        m.comments!==undefined ? "comments" :
        m.shares!==undefined ? "partages" : "";

      return (
        <a href={item.url} target="_blank" rel="noreferrer" className="card block p-4 transition">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <span className="mr-1">{ICON[item.type] || "🔗"}</span>
              <Badge kind={item.type}/>
            </div>
            <span className="text-xs text-gray-600 dark:text-gray-400">{date}</span>
          </div>
          <h3 className="mt-2 font-medium line-clamp-2">{item.title}</h3>
          <div className="mt-2 text-sm text-gray-600 dark:text-gray-400">{label && `${metric} ${label}`}</div>
        </a>
      );
    }

    function SkeletonCard(){
      return (
        <div className="card p-4 animate-pulse">
          <div className="flex justify-between">
            <div className="h-5 w-20 bg-black/10 dark:bg-white/10 rounded"></div>
            <div className="h-4 w-24 bg-black/10 dark:bg-white/10 rounded"></div>
          </div>
          <div className="h-6 w-4/5 bg-black/10 dark:bg-white/10 rounded mt-3"></div>
          <div className="h-4 w-24 bg-black/10 dark:bg-white/10 rounded mt-4"></div>
        </div>
      );
    }

    function App(){
      const [dark, setDark] = useState(()=>localStorage.getItem("theme")==="dark");
      useEffect(()=>{ document.documentElement.classList.toggle("dark", dark); localStorage.setItem("theme", dark?"dark":"light"); },[dark]);

      const [tab, setTab] = useState("search");

      const [name, setName] = useState(localStorage.getItem("rivalytics:lastName") || "");
      const [days, setDays] = useState(localStorage.getItem("rivalytics:days") || 30); // 7|14|30|"all"

      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");
      const [allResults, setAllResults] = useState([]); // cumul progressif
      const [company, setCompany] = useState(null);     // fiche entreprise LinkedIn

      const [types, setTypes] = useState(new Set(ALL_TYPES)); // Affichage
      const [sources, setSources] = useState(new Set((localStorage.getItem("rivalytics:sources")||"rss,youtube,linkedin,instagram,tiktok").split(',').filter(Boolean))); // Coût

      const inputRef = useRef(null);

      useEffect(()=>{inputRef.current?.focus();},[]);
      useEffect(()=>{localStorage.setItem("rivalytics:lastName", name);},[name]);
      useEffect(()=>{localStorage.setItem("rivalytics:days", String(days));},[days]);
      useEffect(()=>{localStorage.setItem("rivalytics:sources", Array.from(sources).join(','));},[sources]);

      function toggleType(t){
        const s = new Set(types);
        s.has(t) ? s.delete(t) : s.add(t);
        if (s.size===0) s.add("Blog");
        setTypes(s);
      }
      function toggleSource(s){
        const next = new Set(sources);
        next.has(s) ? next.delete(s) : next.add(s);
        if (next.size===0) next.add("rss");
        setSources(next);
      }
      function applyPreset(name){
        const p = PRESETS[name];
        if (p) setSources(new Set(p));
      }

      const toDaysParam = (v)=> v==="all" ? 3650 : Number(v||30);

      function pushResults(items = []){
        if(!Array.isArray(items)) return;
        setAllResults(prev=>{
          const next = [...prev, ...items];
          const seen = new Set();
          return next.filter(x=>{
            const u = x.url || '';
            if(!u) return true;
            if(seen.has(u)) return false;
            seen.add(u);
            return true;
          });
        });
      }

      async function runSearch(){
        const raw = name.trim();
        if(!raw) return;
        setLoading(true); setError(""); setAllResults([]); setCompany(null);

        const lower = raw.toLowerCase();
        const handle = slugifyNameToHandle(raw);
        const d = toDaysParam(days);
        const pending = [];

        // LinkedIn
        if (sources.has('linkedin')){
          const u = new URL('/api/linkedin', location.origin);
          const liSlug = toLinkedInSlug(raw);
          u.searchParams.set('slug', liSlug);
          u.searchParams.set('days', String(d));
          u.searchParams.set('limit','20');
          pending.push(
            fetch(u).then(r=>r.json())
              .then(j=>{ setCompany(j.company||null); pushResults(j.items); })
              .catch(()=>{})
          );
        }

        if (sources.has('rss')){
          const u = new URL('/api/rss', location.origin);
          u.searchParams.set('name', lower);
          u.searchParams.set('days', String(d));
          pending.push(fetch(u).then(r=>r.json()).then(j=>pushResults(j.items)).catch(()=>{}));
        }
        if (sources.has('instagram')){
          const u = new URL('/api/instagram', location.origin);
          u.searchParams.set('username', handle);
          u.searchParams.set('limit','12');
          pending.push(fetch(u).then(r=>r.json()).then(j=>pushResults(j.items)).catch(()=>{}));
        }
        if (sources.has('tiktok')){
          const u = new URL('/api/tiktok', location.origin);
          u.searchParams.set('username', handle);
          u.searchParams.set('limit','12');
          pending.push(fetch(u).then(r=>r.json()).then(j=>pushResults(j.items)).catch(()=>{}));
        }
        if (sources.has('youtube')){
          const u = new URL('/api/youtube', location.origin);
          u.searchParams.set('q', raw);
          u.searchParams.set('days', String(d));
          u.searchParams.set('limit','12');
          pending.push(fetch(u).then(r=>r.json()).then(j=>pushResults(j.items)).catch(()=>{}));
        }

        Promise.allSettled(pending).then(()=>{
          // petit check après agrégation
          setError(prev => (allResults.length===0 ? "Aucune donnée récente trouvée." : ""));
          setLoading(false);
        });
      }

      function onSubmit(e){ e.preventDefault(); runSearch(); }

      const filtered = useMemo(()=> allResults.filter(it => types.has(it.type)),[allResults, types]);

      const grouped = useMemo(()=>{
        const m = {};
        for(const it of filtered){
          if(!m[it.type]) m[it.type] = [];
          m[it.type].push(it);
        }
        for(const t of Object.keys(m)){
          m[t].sort((a,b)=> a.date < b.date ? 1 : -1);
        }
        return m;
      },[filtered]);

      return (
        <main className="w-full max-w-6xl">
          <header className="mb-6 flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold">Rivalytics</h1>
              <p className="text-gray-600 dark:text-gray-400 mt-2">
                Nom du concurrent → collecte (RSS / LinkedIn / YouTube / Instagram / TikTok via Apify).
              </p>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={()=>setTab('search')} className={cls('chip', tab==='search' && 'active')}>Recherche</button>
              <button onClick={()=>setTab('compare')} className={cls('chip', tab==='compare' && 'active')}>Comparateur</button>
              <button onClick={()=>setDark(v=>!v)} className="rounded-xl px-3 py-2 border border-gray-300 dark:border-white/20">{dark ? "🌞 Clair" : "🌙 Sombre"}</button>
            </div>
          </header>

          {tab==='search' && (
            <>
              <form onSubmit={onSubmit} className="flex flex-col sm:flex-row gap-3 mb-3">
                <input
                  ref={inputRef}
                  value={name}
                  onChange={e=>setName(e.target.value)}
                  placeholder="Nom / mot-clé (ex: Dev First ou 'javascript')"
                  className="flex-1 rounded-xl border border-gray-300 dark:border-white/10 px-4 py-3 bg-white dark:bg-white/5 outline-none"
                  aria-label="Nom ou mot-clé"
                />
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                  {DAY_PRESETS.map(p=>(
                    <button
                      type="button"
                      key={p.label}
                      onClick={()=>setDays(p.value)}
                      className={cls("chip text-sm", String(days)===String(p.value) && "active")}
                      aria-pressed={String(days)===String(p.value)}
                      title={`Période ${p.label}`}
                    >
                      {p.label}
                    </button>
                  ))}
                </div>
                <button type="submit" disabled={loading || !name.trim()}
                  className="rounded-xl px-5 py-3 bg-indigo-600 text-white disabled:bg-indigo-600/40 hover:bg-indigo-500 transition font-medium">
                  {loading ? "Analyse..." : "Rechercher"}
                </button>
              </form>

              {company && <div className="mb-4"><CompanyCard company={company}/></div>}

              <div className="card p-3 mb-4">
                <div className="flex flex-col gap-3">
                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="group-label">Sources à collecter</span>
                    {["rss","linkedin","youtube","instagram","tiktok"].map(s=>(
                      <button key={s} type="button" onClick={()=>toggleSource(s)}
                        className={cls("chip text-sm", sources.has(s) ? "active" : null)}
                        title={`Source ${s}`}>
                        {ICON[SOURCE_TO_TYPE[s]]} {s.toUpperCase()}
                      </button>
                    ))}
                    <span className="ml-auto flex items-center gap-2">
                      <span className="group-label mr-1">Préréglages</span>
                      {Object.keys(PRESETS).map(p=>(
                        <button key={p} type="button" onClick={()=>applyPreset(p)} className="chip text-sm">{p}</button>
                      ))}
                    </span>
                  </div>

                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="group-label">Types à afficher</span>
                    {ALL_TYPES.map(t=>(
                      <button key={t} type="button" onClick={()=>toggleType(t)}
                        className={cls("chip text-sm", types.has(t) ? "active" : null)}>
                        <span className="mr-1">{ICON[t]}</span> {t}
                      </button>
                    ))}
                    <button type="button" onClick={()=>setTypes(new Set(ALL_TYPES))}
                      className="chip text-sm">Réinit types</button>
                  </div>
                </div>
              </div>

              {error && <div className="text-amber-600 dark:text-amber-300 text-sm mb-3">⚠️ {error}</div>}

              <section className="space-y-6">
                {!loading && (
                  <div className="flex items-center gap-6">
                    <div>
                      <div className="text-2xl font-semibold">{filtered.length}</div>
                      <div className="text-xs text-gray-600 dark:text-gray-400">
                        Total contenus {days==="all" ? "(tout)" : `(${days}j)`}
                      </div>
                    </div>
                    <div className="flex items-center gap-3 text-sm text-gray-700 dark:text-gray-300 flex-wrap">
                      {TYPE_ORDER.filter(t=>grouped[t]?.length).map(t=>(
                        <span key={t} className="inline-flex items-center gap-2">
                          <Badge kind={t}/><span className="text-gray-500 dark:text-gray-400">×{grouped[t].length}</span>
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {loading && allResults.length===0 && (
                  <div role="status" aria-live="polite" className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {Array.from({length:6}).map((_,i)=><SkeletonCard key={i}/>)}
                  </div>
                )}

                {TYPE_ORDER.filter(t => grouped[t]?.length).map(type => (
                  <div key={type} className="space-y-3">
                    <div className="flex items-center gap-2">
                      <span className="text-xl font-semibold">{ICON[type]}</span>
                      <h2 className="text-xl font-semibold">{type}</h2>
                      <span className="text-sm text-gray-500 dark:text-gray-400">({grouped[type].length})</span>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                      {grouped[type].map((it, idx)=> <ResultItem key={it.id || `${type}-${idx}`} item={it}/>)}
                    </div>
                  </div>
                ))}

                {!loading && filtered.length===0 && (
                  <div className="text-gray-600 dark:text-gray-400 text-sm">Aucun résultat pour ces filtres.</div>
                )}
              </section>
            </>
          )}

          {tab==='compare' && (
            <section className="space-y-4 w-full">
              <div className="text-sm text-gray-500 dark:text-gray-400">
                (Le comparateur reste comme avant — on peut aussi le simplifier si tu veux.)
              </div>
            </section>
          )}

          <footer className="mt-10 text-xs text-gray-600 dark:text-gray-500">
            Données <b>réelles</b> via RSS & YouTube + LinkedIn (public “guest”). Instagram & TikTok via Apify (optionnel).
          </footer>
        </main>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>